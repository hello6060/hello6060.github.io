<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>Hello</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hello">
<meta property="og:url" content="http://www.ljh.xyz/index.html">
<meta property="og:site_name" content="Hello">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="LJH">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hello" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.0.2"><script src="/assets/js/DPlayer.min.js"></script></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hello</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://www.ljh.xyz"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-LNMP搭建与个人博客的部署" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/09/21/LNMP%E6%90%AD%E5%BB%BA%E4%B8%8E%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2%E7%9A%84%E9%83%A8%E7%BD%B2/" class="article-date">
  <time datetime="2020-09-20T16:01:18.000Z" itemprop="datePublished">2020-09-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/09/21/LNMP%E6%90%AD%E5%BB%BA%E4%B8%8E%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2%E7%9A%84%E9%83%A8%E7%BD%B2/">LNMP搭建与个人博客的部署</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="LNMP搭建与个人博客的部署"><a href="#LNMP搭建与个人博客的部署" class="headerlink" title="LNMP搭建与个人博客的部署"></a>LNMP搭建与个人博客的部署</h1><p class="note note-primary">primary</p>

<h2 id="环境规划"><a href="#环境规划" class="headerlink" title="环境规划"></a>环境规划</h2><table>
<thead>
<tr>
<th align="center">IP</th>
<th align="center">主机名</th>
<th align="center">节点</th>
</tr>
</thead>
<tbody><tr>
<td align="center">192.168.100.100</td>
<td align="center">master</td>
<td align="center">LNMP平台</td>
</tr>
</tbody></table>
<h2 id="配置基础环境"><a href="#配置基础环境" class="headerlink" title="配置基础环境"></a>配置基础环境</h2><h3 id="关闭防火墙和SElinux"><a href="#关闭防火墙和SElinux" class="headerlink" title="关闭防火墙和SElinux"></a>关闭防火墙和SElinux</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl disable firewalld</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setenforce 0</span><br></pre></td></tr></table></figure>

<h3 id="配置IP地址"><a href="#配置IP地址" class="headerlink" title="配置IP地址"></a>配置IP地址</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/sysconfig/network-scripts/ ## 进入网卡配置文件夹</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi ifcfg-eno16777736  ## 编辑网卡文件</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">TYPE=Ethernet</span><br><span class="line">BOOTPROTO=static  ## 修改为静态IP地址</span><br><span class="line">DEFROUTE=yes</span><br><span class="line">PEERDNS=yes</span><br><span class="line">PEERROUTES=yes</span><br><span class="line">IPV4_FAILURE_FATAL=no</span><br><span class="line">IPV6INIT=yes</span><br><span class="line">IPV6_AUTOCONF=yes</span><br><span class="line">IPV6_DEFROUTE=yes</span><br><span class="line">IPV6_PEERDNS=yes</span><br><span class="line">IPV6_PEERROUTES=yes</span><br><span class="line">IPV6_FAILURE_FATAL=no</span><br><span class="line">NAME=eno16777736</span><br><span class="line">UUID=751ec73f-6cff-486d-93cf-1ddf3d088180</span><br><span class="line">DEVICE=eno16777736</span><br><span class="line">ONBOOT=yes</span><br><span class="line">IPADDR=192.168.100.100    ## 配置IP</span><br><span class="line">NETWORK=255.255.255.0     ## 配置网络掩码</span><br></pre></td></tr></table></figure>

<p>wq保存退出</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart network ## 重启网络服务</span><br></pre></td></tr></table></figure>

<p>在宿主机验证网络配置是否正确</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ping 192.168.100.100</span><br></pre></td></tr></table></figure>

<p>无法ping通:</p>
<ul>
<li>检查宿主机仅主机模式网卡是否开启<img src="http://img.ljh666.xyz/img/20200930195133.png"></li>
<li>检查vmware是否连接仅主机模式网卡<img src="http://img.ljh666.xyz/img/20200930195055.png"></li>
</ul>
<p>使用CRT连接虚拟机, 进行后续操作</p>
<p><img src="http://img.ljh666.xyz/img/20200930195232.png"></p>
<p><img src="http://img.ljh666.xyz/img/20200930195344.png"></p>
<h3 id="配置YUM源"><a href="#配置YUM源" class="headerlink" title="配置YUM源"></a>配置YUM源</h3><p>备份官方yum配置文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir /root/backup    ## 创建一个用于存放备份文件的文件夹</span><br><span class="line">cd /etc/yum.repos.d/  ## 进入yum配置文件存放文件夹</span><br><span class="line">mv ./* /root/backup   ## 备份</span><br></pre></td></tr></table></figure>

<p>配置本地yum源(等同离线版应用商店)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi local.repo ## 必须以.repo结尾</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[local]</span><br><span class="line">name&#x3D;local</span><br><span class="line">baseurl&#x3D;file:&#x2F;&#x2F;&#x2F;media&#x2F;cdrom</span><br><span class="line">gpgcheck&#x3D;0</span><br><span class="line">enabled&#x3D;1</span><br><span class="line"></span><br><span class="line">[lnmp]</span><br><span class="line">name&#x3D;lnmp</span><br><span class="line">baseurl&#x3D;file:&#x2F;&#x2F;&#x2F;root&#x2F;lnmp</span><br><span class="line">gpgcheck&#x3D;0</span><br><span class="line">enabled&#x3D;1</span><br></pre></td></tr></table></figure>

<p>挂载镜像文件(/media/cdrom)</p>
<p>可以看到镜像文件CentOS-7-x86_64-DVD-1511.iso和lnmp都在root的家目录下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# ls</span><br><span class="line">anaconda-ks.cfg               Docker.tar.gz  wordpress-4.7.3-zh_CN.zip</span><br><span class="line">CentOS-7-x86_64-DVD-1511.iso  K8S.tar.gz     xiandian</span><br><span class="line">cirros-0.3.4-x86_64-disk.img  lnmp</span><br></pre></td></tr></table></figure>

<p>挂载</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# mkdir /media/cdrom/  ## 创建用于挂载的文件夹</span><br><span class="line">[root@localhost ~]# mount /root/CentOS-7-x86_64-DVD-1511.iso /media/cdrom/</span><br><span class="line">mount: /dev/loop1 is write-protected, mounting read-only</span><br></pre></td></tr></table></figure>

<p>(其他lnmp本身就是本地的文件夹, 所以无挂载可言)</p>
<p>检查yum源配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum list</span><br></pre></td></tr></table></figure>

<p>若只打印出许多rpm软件包的名字则配置正确</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# yum repolist</span><br><span class="line">Loaded plugins: fastestmirror</span><br><span class="line">Repodata is over 2 weeks old. Install yum-cron? Or run: yum makecache fast</span><br><span class="line">Loading mirror speeds from cached hostfile</span><br><span class="line">repo id                               repo name                           status</span><br><span class="line">!lnmp                                 lnmp                                  178</span><br><span class="line">!local                                local                               3,723</span><br></pre></td></tr></table></figure>

<p>至此基础配置<strong>完成</strong>, 再做一次<strong>快照</strong>保存当前的状态</p>
<h2 id=""><a href="#" class="headerlink" title=""></a></h2><p>接下来开始LNMP平台的搭建</p>
<h2 id="安装mariadb"><a href="#安装mariadb" class="headerlink" title="安装mariadb"></a>安装mariadb</h2><blockquote>
<p>mariadb是mysql的分支</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install mariadb mariadb-server</span><br></pre></td></tr></table></figure>

<p>安装过程可能有点慢</p>
<ul>
<li>mariadb 数据库的客户端程序(通过这个程序可以输入sql语句)</li>
<li>mariadb-server 数据库服务程序</li>
</ul>
<p>启动mariadb服务程序</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start mariadb</span><br></pre></td></tr></table></figure>

<p>初始化mariadb</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql_secure_installation</span><br></pre></td></tr></table></figure>

<blockquote>
<p>交换界面操作:</p>
<p>直接回车</p>
<p>输入y +回车</p>
<p>输入root(mariadb的root用户)密码000000</p>
<p>再次输入密码</p>
<p>输入y +回车</p>
<p>输入n+回车</p>
<p>输入y +回车</p>
<p>输入y +回车</p>
</blockquote>
<p>登录mariadb</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -p000000  ## 注意空格的位置</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# mysql -uroot -p000000  </span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MariaDB connection id is 2</span><br><span class="line">Server version: 5.5.44-MariaDB MariaDB Server</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2015, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type &#39;help;&#39; or &#39;\h&#39; for help. Type &#39;\c&#39; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; </span><br></pre></td></tr></table></figure>

<p>使用<code>Ctrl+C</code>或者输入<code>quit</code>退出交换界面</p>
<h2 id="安装php"><a href="#安装php" class="headerlink" title="安装php"></a>安装php</h2><p>需要安装的软件包</p>
<ul>
<li>php</li>
<li>php-fpm(php与nginx通信用)</li>
<li>php-mysql(php与maraidb通信用)</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install php php-fpm php-mysql</span><br></pre></td></tr></table></figure>

<p>编辑php配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi &#x2F;etc&#x2F;php-fpm.d&#x2F;www.conf</span><br></pre></td></tr></table></figure>

<p>末行模式输入set nu可以显示行号</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">38 ; RPM: apache Choosed to be able to access some dir as httpd</span><br><span class="line">39 user = nginx  # 修改用户为nginx</span><br><span class="line">40 ; RPM: Keep a group allowed to write in log dir.</span><br><span class="line">41 group = nginx  # 修改用户组为nginx</span><br></pre></td></tr></table></figure>
<p>输入wq保存退出</p>
<p>启动php-fpm</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start php-fpm</span><br></pre></td></tr></table></figure>



<h2 id="安装nginx"><a href="#安装nginx" class="headerlink" title="安装nginx"></a>安装nginx</h2><blockquote>
<p>nginx等同于Apache | IIS</p>
</blockquote>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install nginx</span><br></pre></td></tr></table></figure>

<h3 id="配置nginx"><a href="#配置nginx" class="headerlink" title="配置nginx"></a>配置nginx</h3><p>指定网站根目录</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir /www ## 创建网站根目录文件夹</span><br><span class="line">chown nginx:nginx -R /www  ## 更改根目录文件夹的宿主为nginx用户</span><br></pre></td></tr></table></figure>

<p>编辑配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;default.conf </span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> 8     location / &#123;</span><br><span class="line"> 9         root   /www;    ## 修改根目录</span><br><span class="line">10         index  index.html index.htm index.php;  ## 添加index.php文件为默认页面</span><br><span class="line">11     &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">30     location ~ \.php$ &#123;         ## 取消30到36行前面的注释&quot;#&quot;</span><br><span class="line">31         root           html;</span><br><span class="line">32         fastcgi_pass   127.0.0.1:9000;</span><br><span class="line">33         fastcgi_index  index.php;</span><br><span class="line">34         fastcgi_param  SCRIPT_FILENAME  /www$fastcgi_script_name;   ## 修改此行</span><br><span class="line">35         include        fastcgi_params;</span><br><span class="line">36     &#125;</span><br></pre></td></tr></table></figure>

<p>启动nginx</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start nginx</span><br></pre></td></tr></table></figure>

<h2 id="测试环境"><a href="#测试环境" class="headerlink" title="测试环境"></a>测试环境</h2><p>进入网站根目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;www</span><br></pre></td></tr></table></figure>

<p>创建测试文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;&lt;?php phpinfo();&quot; &gt; index.php</span><br></pre></td></tr></table></figure>

<p>使用浏览器输入IP地址访问</p>
<p><img src="http://img.ljh666.xyz/img/PJWLFXU3%5BJSDEA6VI%5DMMF6B.png"></p>
<p>出现上面的页面就说明php与nginx均正确安装</p>
<h2 id="部署个人博客系统"><a href="#部署个人博客系统" class="headerlink" title="部署个人博客系统"></a>部署个人博客系统</h2><p>*下载wordpress安装包</p>
<p>wordpress安装包在/root目录下</p>
<h3 id="解压安装包"><a href="#解压安装包" class="headerlink" title="解压安装包"></a>解压安装包</h3><p>下载解压软件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install unzip</span><br></pre></td></tr></table></figure>

<p>解压</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unzip &#x2F;root&#x2F;wordpress-4.7.3-zh_CN.zip -d &#x2F;root&#x2F;</span><br></pre></td></tr></table></figure>

<p>将wordpress目录中的所有文件复制到nginx网站根目录下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/cp -rf /root/wordpress/* /www/  ## 覆盖且递归的复制文件</span><br></pre></td></tr></table></figure>

<p>查看复制的文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost www]# ll</span><br><span class="line">total 184</span><br><span class="line">-rw-r--r--.  1 root root   418 Aug 14 01:03 index.php</span><br><span class="line">-rw-r--r--.  1 root root 19935 Aug 14 01:03 license.txt</span><br><span class="line">-rw-r--r--.  1 root root  6956 Aug 14 01:03 readme.html</span><br><span class="line">-rw-r--r--.  1 root root  5447 Aug 14 01:03 wp-activate.php</span><br><span class="line">drwxr-xr-x.  9 root root  4096 Aug 14 01:03 wp-admin</span><br><span class="line">-rw-r--r--.  1 root root   364 Aug 14 01:03 wp-blog-header.php</span><br><span class="line">-rw-r--r--.  1 root root  1627 Aug 14 01:03 wp-comments-post.php</span><br><span class="line">-rw-r--r--.  1 root root  2930 Aug 14 01:03 wp-config-sample.php</span><br><span class="line">drwxr-xr-x.  5 root root    65 Aug 14 01:03 wp-content</span><br><span class="line">-rw-r--r--.  1 root root  3286 Aug 14 01:03 wp-cron.php</span><br><span class="line">drwxr-xr-x. 18 root root  8192 Aug 14 01:04 wp-includes</span><br><span class="line">-rw-r--r--.  1 root root  2422 Aug 14 01:04 wp-links-opml.php</span><br><span class="line">-rw-r--r--.  1 root root  3301 Aug 14 01:04 wp-load.php</span><br><span class="line">-rw-r--r--.  1 root root 33939 Aug 14 01:04 wp-login.php</span><br><span class="line">-rw-r--r--.  1 root root  8048 Aug 14 01:04 wp-mail.php</span><br><span class="line">-rw-r--r--.  1 root root 16250 Aug 14 01:04 wp-settings.php</span><br><span class="line">-rw-r--r--.  1 root root 29896 Aug 14 01:04 wp-signup.php</span><br><span class="line">-rw-r--r--.  1 root root  4513 Aug 14 01:04 wp-trackback.php</span><br><span class="line">-rw-r--r--.  1 root root  3065 Aug 14 01:04 xmlrpc.php</span><br></pre></td></tr></table></figure>

<p>可以看到权限不足</p>
<p>更改文件宿主(实际生产环境中需要针对不同情况给权限)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chown -R nginx:nginx /www  ## 递归修改根目录下的文件宿主</span><br></pre></td></tr></table></figure>

<p>再次查看文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost www]# ll</span><br><span class="line">total 184</span><br><span class="line">-rw-r--r--.  1 nginx nginx   418 Aug 14 01:03 index.php</span><br><span class="line">-rw-r--r--.  1 nginx nginx 19935 Aug 14 01:03 license.txt</span><br><span class="line">-rw-r--r--.  1 nginx nginx  6956 Aug 14 01:03 readme.html</span><br><span class="line">-rw-r--r--.  1 nginx nginx  5447 Aug 14 01:03 wp-activate.php</span><br><span class="line">drwxr-xr-x.  9 nginx nginx  4096 Aug 14 01:03 wp-admin</span><br><span class="line">-rw-r--r--.  1 nginx nginx   364 Aug 14 01:03 wp-blog-header.php</span><br><span class="line">-rw-r--r--.  1 nginx nginx  1627 Aug 14 01:03 wp-comments-post.php</span><br><span class="line">-rw-r--r--.  1 nginx nginx  2930 Aug 14 01:03 wp-config-sample.php</span><br><span class="line">drwxr-xr-x.  5 nginx nginx    65 Aug 14 01:03 wp-content</span><br><span class="line">-rw-r--r--.  1 nginx nginx  3286 Aug 14 01:03 wp-cron.php</span><br><span class="line">drwxr-xr-x. 18 nginx nginx  8192 Aug 14 01:04 wp-includes</span><br><span class="line">-rw-r--r--.  1 nginx nginx  2422 Aug 14 01:04 wp-links-opml.php</span><br><span class="line">-rw-r--r--.  1 nginx nginx  3301 Aug 14 01:04 wp-load.php</span><br><span class="line">-rw-r--r--.  1 nginx nginx 33939 Aug 14 01:04 wp-login.php</span><br><span class="line">-rw-r--r--.  1 nginx nginx  8048 Aug 14 01:04 wp-mail.php</span><br><span class="line">-rw-r--r--.  1 nginx nginx 16250 Aug 14 01:04 wp-settings.php</span><br><span class="line">-rw-r--r--.  1 nginx nginx 29896 Aug 14 01:04 wp-signup.php</span><br><span class="line">-rw-r--r--.  1 nginx nginx  4513 Aug 14 01:04 wp-trackback.php</span><br><span class="line">-rw-r--r--.  1 nginx nginx  3065 Aug 14 01:04 xmlrpc.php</span><br></pre></td></tr></table></figure>



<h3 id="配置数据库"><a href="#配置数据库" class="headerlink" title="配置数据库"></a>配置数据库</h3><p>创建一个给wordpress使用的数据库用户</p>
<p>再次登录数据库</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# mysql -uroot -p000000</span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MariaDB connection id is 3</span><br><span class="line">Server version: 5.5.44-MariaDB MariaDB Server</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2015, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"></span><br><span class="line">Type &#x27;help;&#x27; or &#x27;\h&#x27; for help. Type &#x27;\c&#x27; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; </span><br></pre></td></tr></table></figure>

<p>创建用户wp_root</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [(none)]&gt; grant all privileges on *.* to &#x27;wp_root&#x27;@&#x27;%&#x27; identified by &#x27;000000&#x27;;</span><br><span class="line"></span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>创建给wordpress使用的数据库</p>
<p>创建wp_db库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [(none)]&gt; create database wp_db;</span><br><span class="line"></span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>退出</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [(none)]&gt; quit</span><br><span class="line">Bye</span><br></pre></td></tr></table></figure>



<h3 id="配置wordpress"><a href="#配置wordpress" class="headerlink" title="配置wordpress"></a>配置wordpress</h3><p>访问</p>
<p>使用浏览器输入IP地址192.168.100.100访问</p>
<p><img src="http://img.ljh666.xyz/img/20200930220250.png"></p>
<p><img src="http://img.ljh666.xyz/img/20200930220340.png"></p>
<p>提交后看到如下提示</p>
<p><img src="http://img.ljh666.xyz/img/20200930220754.png"></p>
<p>按照提示创建文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi &#x2F;www&#x2F;wp-config.php </span><br></pre></td></tr></table></figure>

<p>将提示内容复制到文件中(进入编辑模式后再复制)</p>
<p><img src="http://img.ljh666.xyz/img/20200930224325.png"></p>
<p><img src="http://img.ljh666.xyz/img/20200930224438.png"></p>
<p>登录后即可看到wordpress的后台</p>
<blockquote>
<p>wordpress的后台地址是http:/IP地址/wp-admin/</p>
<p>wordpress的前台地址是http:/IP地址/</p>
</blockquote>
<p><img src="http://img.ljh666.xyz/img/image-20200930224625611.png"></p>
<h2 id="使用wordpress"><a href="#使用wordpress" class="headerlink" title="使用wordpress"></a>使用wordpress</h2><p>编写一篇文章并发布</p>
<p><img src="http://img.ljh666.xyz/img/20200930225022.png"></p>
<p>浏览器访问前台页面</p>
<p><img src="http://img.ljh666.xyz/img/20200930225135.png"></p>
<p>文章发布成功,  wordpress还有其他强大的功能, 自行探索</p>
<p>至此使用LNMP平台部署wordpress个人博客已经完成</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><blockquote>
<p>如果访问nginx提示被拒绝, 可以查看Linux的防火墙是否关闭</p>
</blockquote>
<blockquote>
<p>Linux中, 一切皆文件<br>大部分配置文件的修改都不会被直接应用, 需指定系统重新加载配置文件才被应用(如:重启服务)</p>
</blockquote>
<h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><p><a target="_blank" rel="noopener" href="https://www.wpdaxue.com/wordpress-file-read-and-write-permission.html">WordPress文件读写权限建议</a></p>
<h2 id="附"><a href="#附" class="headerlink" title="附"></a>附</h2><p><a target="_blank" rel="noopener" href="http://www.ljh666.xyz/2020/07/30/%E5%9C%A8Centos%E4%B8%8A%E5%AE%89%E8%A3%85HEXO%E7%9A%84%E6%95%99%E7%A8%8B/">部署基于Hexo的个人博客</a></p>
<p><a class="btn" href="" title="已完结">end</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.ljh.xyz/2020/09/21/LNMP%E6%90%AD%E5%BB%BA%E4%B8%8E%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2%E7%9A%84%E9%83%A8%E7%BD%B2/" data-id="ckkzd08h900047ou1avgxhhqf" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Centos/" rel="tag">Centos</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/LNMP/" rel="tag">LNMP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux/" rel="tag">Linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wordpress/" rel="tag">wordpress</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%BA%91%E8%AE%A1%E7%AE%97%E5%88%9D%E7%BA%A7/" rel="tag">云计算初级</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%8D%9A%E5%AE%A2/" rel="tag">博客</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-用Python写一个简单的交互式SSH客户端" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/11/01/%E7%94%A8Python%E5%86%99%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E4%BA%A4%E4%BA%92%E5%BC%8FSSH%E5%AE%A2%E6%88%B7%E7%AB%AF/" class="article-date">
  <time datetime="2020-11-01T08:50:00.000Z" itemprop="datePublished">2020-11-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/11/01/%E7%94%A8Python%E5%86%99%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E4%BA%A4%E4%BA%92%E5%BC%8FSSH%E5%AE%A2%E6%88%B7%E7%AB%AF/">用Python写一个简单的交互式SSH客户端</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="用Python写一个简单的交互式SSH客户端"><a href="#用Python写一个简单的交互式SSH客户端" class="headerlink" title="用Python写一个简单的交互式SSH客户端"></a>用Python写一个简单的交互式SSH客户端</h1><p>在学习了python自动脚本后,  就想写一个简单的shell</p>
<p>使用的是paramiko包</p>
<p class="note note-info">简介</p>

<blockquote>
<p>ssh是一个协议，OpenSSH是其中一个开源实现，paramiko是Python的一个库，实现了SSHv2协议(底层使用cryptography)。</p>
<p>有了Paramiko以后，我们就可以在Python代码中直接使用SSH协议对远程服务器执行操作，而不是通过ssh命令对远程服务器进行操作。</p>
<p>paramiko包含两个核心组件：SSHClient和SFTPClient。</p>
</blockquote>
<p>在自动脚本中命令间是隔离的, 但我想要程序能做到交互的功能, 所以要保持住ssh的状态, 之前的exec_command函数无法使用了</p>
<p>这里我使用了invoke_shell函数(区别在于invoke_shell使用SSH shell通道,而exec_command使用SSH exec通道)</p>
<p class="note note-primary">代码</p>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> paramiko, time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send</span>(<span class="params">cmd, channel</span>):</span></span><br><span class="line">    cmd += <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">    result = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    channel.send(cmd)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 有些命令执行需要较长时间, 这里使用循环做回显等待</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        time.sleep(<span class="number">0.2</span>)</span><br><span class="line">        <span class="comment"># recv会将我们输入的cmd带回来, 将其切割掉</span></span><br><span class="line">        res = channel.recv(<span class="number">65535</span>)[len(cmd):]</span><br><span class="line">        res = res.decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        result += res</span><br><span class="line">        print(res,end=<span class="string">&quot;&quot;</span>)</span><br><span class="line">    <span class="comment"># 判断通道是否已经空闲</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> channel.recv_ready():</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    ssh = paramiko.SSHClient()</span><br><span class="line">    ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())  <span class="comment"># 忽略主机key</span></span><br><span class="line">    ssh.connect(<span class="string">&#x27;10.10.10.200&#x27;</span>, port=<span class="number">22</span>, username=<span class="string">&#x27;root&#x27;</span>, password=<span class="string">&#x27;000000&#x27;</span>, compress=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    channel = ssh.invoke_shell()</span><br><span class="line">    send(<span class="string">&quot;\n&quot;</span>, channel)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        cmd = input(<span class="string">&quot;&quot;</span>)</span><br><span class="line">        send(cmd,channel)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p class="note note-success">运行</p>

<p><img src="http://img.ljh666.xyz/img/20201101164441.png"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.ljh.xyz/2020/11/01/%E7%94%A8Python%E5%86%99%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E4%BA%A4%E4%BA%92%E5%BC%8FSSH%E5%AE%A2%E6%88%B7%E7%AB%AF/" data-id="ckkzd08i300117ou17jit3fhw" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Python/" rel="tag">Python</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/shell/" rel="tag">shell</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-视频测试" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/08/23/%E8%A7%86%E9%A2%91%E6%B5%8B%E8%AF%95/" class="article-date">
  <time datetime="2020-08-22T16:01:18.000Z" itemprop="datePublished">2020-08-23</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/08/23/%E8%A7%86%E9%A2%91%E6%B5%8B%E8%AF%95/">视频测试</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Minecraft-Wet-Hands-Acapella"><a href="#Minecraft-Wet-Hands-Acapella" class="headerlink" title="Minecraft - Wet Hands Acapella"></a>Minecraft - Wet Hands Acapella</h1><video width="100%" controls autoplay >
<source src="http://img.ljh666.xyz/Minecraft%20-%20Wet%20Hands%20Acapella.mp4">
</video>


<div id="dplayer0" class="dplayer hexo-tag-dplayer-mark" style="margin-bottom: 20px;"></div><script>(function(){var player = new DPlayer({"container":document.getElementById("dplayer0"),"video":{"url":"http://img.ljh666.xyz/Minecraft%20-%20Wet%20Hands%20Acapella.mp4"}});window.dplayers||(window.dplayers=[]);window.dplayers.push(player);})()</script>


<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;video width&#x3D;&quot;100%&quot; controls autoplay &gt;</span><br><span class="line">&lt;source src&#x3D;&quot;http:&#x2F;&#x2F;img.ljh666.xyz&#x2F;Minecraft%20-%20Wet%20Hands%20Acapella.mp4&quot;&gt;</span><br><span class="line">&lt;&#x2F;video&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% dplayer &quot;url&#x3D;http:&#x2F;&#x2F;img.ljh666.xyz&#x2F;Minecraft%20-%20Wet%20Hands%20Acapella.mp4&quot; %&#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.ljh.xyz/2020/08/23/%E8%A7%86%E9%A2%91%E6%B5%8B%E8%AF%95/" data-id="ckkzd08i2000z7ou19ef6exia" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E8%A7%86%E9%A2%91/" rel="tag">视频</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Docker容器编排[Docker compose]" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/08/21/Docker%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92%5BDocker%20compose%5D/" class="article-date">
  <time datetime="2020-08-20T16:01:18.000Z" itemprop="datePublished">2020-08-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/08/21/Docker%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92%5BDocker%20compose%5D/">Docker容器编排[Docker compose]</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Docker容器编排-Docker-compose"><a href="#Docker容器编排-Docker-compose" class="headerlink" title="Docker容器编排[Docker compose]"></a>Docker容器编排[Docker compose]</h1><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>Docker-Compose是一个容器编排的工具，适用于所有环境：生产、开发、测试以及CI工作流程</p>
<p><img src="http://img.ljh666.xyz/img/20200820231726.png"></p>
<p><img src="http://img.ljh666.xyz/img/20200820231754.png"></p>
<h2 id="安装Docker-compose"><a href="#安装Docker-compose" class="headerlink" title="安装Docker-compose"></a>安装Docker-compose</h2><blockquote>
<p>工作流程要求: </p>
<p>①构建一个基于Python3.4的镜像。<br>②把当前目录添加到镜像中的/code路径下。<br>③把工作路径设置成/code。<br>④安装Python依赖。<br>⑤设置容器的默认命令为pythonapp.py。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https:&#x2F;&#x2F;github.com&#x2F;docker&#x2F;compose&#x2F;releases&#x2F;download&#x2F;1.26.2&#x2F;docker-compose-Linux-x86_64</span><br></pre></td></tr></table></figure>

<p>添加到系统任意一个bin文件夹(PATH常量中的任意)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv docker-compose-Linux-x86_64 &#x2F;usr&#x2F;local&#x2F;bin&#x2F;docker-compose</span><br></pre></td></tr></table></figure>

<p>给权限</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod +x &#x2F;usr&#x2F;local&#x2F;bin&#x2F;docker-compose</span><br></pre></td></tr></table></figure>

<h2 id="使用compose"><a href="#使用compose" class="headerlink" title="使用compose"></a>使用compose</h2><p>创建实验文件目录</p>
<h3 id="编写实验文件"><a href="#编写实验文件" class="headerlink" title="编写实验文件"></a>编写实验文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir composetest</span><br><span class="line">cd !$</span><br></pre></td></tr></table></figure>

<p>编写实验用python文件app.py</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">import time</span><br><span class="line"></span><br><span class="line">import redis</span><br><span class="line">from flask import Flask</span><br><span class="line"></span><br><span class="line">app &#x3D; Flask(__name__)</span><br><span class="line">cache &#x3D; redis.Redis(host&#x3D;&#39;redis&#39;,port&#x3D;6379)</span><br><span class="line"></span><br><span class="line">def get_hit_count(): </span><br><span class="line">    retries&#x3D;5</span><br><span class="line">    while True:</span><br><span class="line">        try:</span><br><span class="line">            return cache.incr(&#39;hits&#39;)</span><br><span class="line">        except redis.exceptions.ConnectionError as  exc:</span><br><span class="line">            if retries &#x3D;&#x3D; 0:</span><br><span class="line">                raise exc</span><br><span class="line">            retries -&#x3D; 1</span><br><span class="line">            time.sleep(0.5)</span><br><span class="line"></span><br><span class="line">@app.route(&#39;&#x2F;&#39;)</span><br><span class="line">def hello():</span><br><span class="line">    count &#x3D; get_hit_count()</span><br><span class="line">    return &#39;HelloWorld!I have been seen &#123;&#125; times.\n&#39;.format(count)</span><br><span class="line">if __name__ &#x3D;&#x3D; &quot;__main__&quot;:</span><br><span class="line">    app.run(host&#x3D;&quot;0.0.0.0&quot;,debug&#x3D;True)</span><br></pre></td></tr></table></figure>

<p>在这个例子中，Redis就是应用网络中Redis容器的主机名。端口使用的Redis默认端口6379。</p>
<p>创建requirements.txt文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@master composetest]# vim requirements.txt</span><br><span class="line"></span><br><span class="line">flask</span><br><span class="line">redis</span><br></pre></td></tr></table></figure>

<p>创建Dockfile文件</p>
<p>在这一步中，需要编写一个Dockerfile来构建一个Docker镜像。这个镜像包含Python应用的所有依赖，也包含Python其本身。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@master composetest]# vim Dockerfile</span><br><span class="line"></span><br><span class="line">FROM python:3.4-alpine</span><br><span class="line">ADD . &#x2F;code</span><br><span class="line">WORKDIR &#x2F;code</span><br><span class="line">RUN pip install -r requirements.txt --default-timeout&#x3D;100</span><br><span class="line">CMD [&quot;python&quot;,&quot;app.py&quot;]</span><br></pre></td></tr></table></figure>

<blockquote>
<p>–default-timeout=100加大下载延迟, 防止报错</p>
</blockquote>
<p>创建docker-compose.yml文件, 定义服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@master composetest]# vim docker-compose.yml</span><br><span class="line"></span><br><span class="line">version: &#39;3&#39;</span><br><span class="line">services:</span><br><span class="line">        web:</span><br><span class="line">                build: .</span><br><span class="line">                ports:</span><br><span class="line">                 - &quot;5000:5000&quot;</span><br><span class="line">        redis:</span><br><span class="line">                image: &quot;redis:alpine&quot;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这个Compose文件中定义了两个服务Web与Redis。</p>
<p>Web服务使用当前目录Dockerfile构建出来的镜像，并且将容器上暴露的5000端口转发到主机的5000端口，使用FlaskWeb服务器的默认端口5000。</p>
<p>Redis服务使用从DockerHub注册表中拉取的公有镜像。</p>
</blockquote>
<h3 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">[root@master composetest]# docker-compose up                           </span><br><span class="line">WARNING: The Docker Engine you&#39;re using is running in swarm mode.</span><br><span class="line"></span><br><span class="line">Compose does not use swarm mode to deploy services to multiple nodes in a swarm. All containers will be scheduled on the current node.</span><br><span class="line"></span><br><span class="line">To deploy your application across the swarm, use &#96;docker stack deploy&#96;.</span><br><span class="line"></span><br><span class="line">Building web</span><br><span class="line">Step 1&#x2F;5 : FROM python:3.4-alpine</span><br><span class="line"> ---&gt; c06adcf62f6e</span><br><span class="line">Step 2&#x2F;5 : ADD . &#x2F;code</span><br><span class="line"> ---&gt; 89c5e466ba6c</span><br><span class="line">Removing intermediate container 70b69b9389aa</span><br><span class="line">Step 3&#x2F;5 : WORKDIR &#x2F;code</span><br><span class="line"> ---&gt; 30266305bc88</span><br><span class="line">Removing intermediate container 0b0da116d8a4</span><br><span class="line">Step 4&#x2F;5 : RUN pip install -r requirements.txt --default-timeout&#x3D;1000</span><br><span class="line"> ---&gt; Running in c6f549841948</span><br><span class="line"></span><br><span class="line">DEPRECATION: Python 3.4 support has been deprecated. pip 19.1 will be the last one supporting it. Please upgrade your Python as Python 3.4 won&#39;t be maintained after March 2019 (cf PEP 429).</span><br><span class="line">Collecting flask (from -r requirements.txt (line 1))</span><br><span class="line">  Downloading https:&#x2F;&#x2F;files.pythonhosted.org&#x2F;packages&#x2F;d8&#x2F;94&#x2F;7350820ae209ccdba073f83220cea1c376f2621254d1e0e82609c9a65e58&#x2F;Flask-1.0.4-py2.py3-none-any.whl (92kB)</span><br><span class="line">Collecting redis (from -r requirements.txt (line 2))</span><br><span class="line">  Downloading https:&#x2F;&#x2F;files.pythonhosted.org&#x2F;packages&#x2F;32&#x2F;ae&#x2F;28613a62eea0d53d3db3147f8715f90da07667e99baeedf1010eb400f8c0&#x2F;redis-3.3.11-py2.py3-none-any.whl (66kB)</span><br><span class="line">Collecting itsdangerous&gt;&#x3D;0.24 (from flask-&gt;-r requirements.txt (line 1))</span><br><span class="line">  Downloading https:&#x2F;&#x2F;files.pythonhosted.org&#x2F;packages&#x2F;76&#x2F;ae&#x2F;44b03b253d6fade317f32c24d100b3b35c2239807046a4c953c7b89fa49e&#x2F;itsdangerous-1.1.0-py2.py3-none-any.whl</span><br><span class="line">Collecting Werkzeug&gt;&#x3D;0.14 (from flask-&gt;-r requirements.txt (line 1))</span><br><span class="line">  Downloading https:&#x2F;&#x2F;files.pythonhosted.org&#x2F;packages&#x2F;c2&#x2F;e4&#x2F;a859d2fe516f466642fa5c6054fd9646271f9da26b0cac0d2f37fc858c8f&#x2F;Werkzeug-0.16.1-py2.py3-none-any.whl (327kB)</span><br><span class="line">Collecting Jinja2&gt;&#x3D;2.10 (from flask-&gt;-r requirements.txt (line 1))</span><br><span class="line">  Downloading https:&#x2F;&#x2F;files.pythonhosted.org&#x2F;packages&#x2F;65&#x2F;e0&#x2F;eb35e762802015cab1ccee04e8a277b03f1d8e53da3ec3106882ec42558b&#x2F;Jinja2-2.10.3-py2.py3-none-any.whl (125kB)</span><br><span class="line">Collecting click&gt;&#x3D;5.1 (from flask-&gt;-r requirements.txt (line 1))</span><br><span class="line">  Downloading https:&#x2F;&#x2F;files.pythonhosted.org&#x2F;packages&#x2F;fa&#x2F;37&#x2F;45185cb5abbc30d7257104c434fe0b07e5a195a6847506c074527aa599ec&#x2F;Click-7.0-py2.py3-none-any.whl (81kB)</span><br><span class="line">Collecting MarkupSafe&gt;&#x3D;0.23 (from Jinja2&gt;&#x3D;2.10-&gt;flask-&gt;-r requirements.txt (line 1))</span><br><span class="line">  Downloading https:&#x2F;&#x2F;files.pythonhosted.org&#x2F;packages&#x2F;b9&#x2F;2e&#x2F;64db92e53b86efccfaea71321f597fa2e1b2bd3853d8ce658568f7a13094&#x2F;MarkupSafe-1.1.1.tar.gz</span><br><span class="line">Building wheels for collected packages: MarkupSafe</span><br><span class="line">  Building wheel for MarkupSafe (setup.py): started</span><br><span class="line">  Building wheel for MarkupSafe (setup.py): finished with status &#39;done&#39;</span><br><span class="line">  Stored in directory: &#x2F;root&#x2F;.cache&#x2F;pip&#x2F;wheels&#x2F;f2&#x2F;aa&#x2F;04&#x2F;0edf07a1b8a5f5f1aed7580fffb69ce8972edc16a505916a77</span><br><span class="line">Successfully built MarkupSafe</span><br><span class="line">Installing collected packages: itsdangerous, Werkzeug, MarkupSafe, Jinja2, click, flask, redis</span><br><span class="line">Successfully installed Jinja2-2.10.3 MarkupSafe-1.1.1 Werkzeug-0.16.1 click-7.0 flask-1.0.4 itsdangerous-1.1.0 redis-3.3.11</span><br><span class="line">You are using pip version 19.0.3, however version 19.1.1 is available.</span><br><span class="line">You should consider upgrading via the &#39;pip install --upgrade pip&#39; command.</span><br><span class="line"> ---&gt; b38789157f62</span><br><span class="line">Removing intermediate container c6f549841948</span><br><span class="line">Step 5&#x2F;5 : CMD python app.py</span><br><span class="line"> ---&gt; Running in 0e5103df7977</span><br><span class="line"> ---&gt; e1d437e52801</span><br><span class="line">Removing intermediate container 0e5103df7977</span><br><span class="line">Successfully built e1d437e52801</span><br><span class="line">WARNING: Image for service web was built because it did not already exist. To rebuild this image you must use &#96;docker-compose build&#96; or &#96;docker-compose up --build&#96;.</span><br><span class="line">Pulling redis (redis:alpine)...</span><br><span class="line">Trying to pull repository docker.io&#x2F;library&#x2F;redis ... </span><br><span class="line">alpine: Pulling from docker.io&#x2F;library&#x2F;redis</span><br><span class="line">df20fa9351a1: Pull complete</span><br><span class="line">9b8c029ceab5: Pull complete</span><br><span class="line">e983a1eb737a: Pull complete</span><br><span class="line">660ad543c5fc: Pull complete</span><br><span class="line">823cbe4f5025: Pull complete</span><br><span class="line">e3dd0c30e1c8: Pull complete</span><br><span class="line">Digest: sha256:6972ee00fd35854dd2925904e23cb047faa004df27c62cba842248c7db6bd99d</span><br><span class="line">Status: Downloaded newer image for docker.io&#x2F;redis:alpine</span><br><span class="line">Creating test_redis_1 ... done</span><br><span class="line">Creating test_web_1   ... done</span><br><span class="line">Attaching to test_redis_1, test_web_1</span><br><span class="line">redis_1  | 1:C 20 Aug 2020 16:46:45.289 # oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo</span><br><span class="line">redis_1  | 1:C 20 Aug 2020 16:46:45.289 # Redis version&#x3D;6.0.6, bits&#x3D;64, commit&#x3D;00000000, modified&#x3D;0, pid&#x3D;1, just started</span><br><span class="line">redis_1  | 1:C 20 Aug 2020 16:46:45.289 # Warning: no config file specified, using the default config. In order to specify a config file use redis-server &#x2F;path&#x2F;to&#x2F;redis.conf</span><br><span class="line">redis_1  | 1:M 20 Aug 2020 16:46:45.290 * Running mode&#x3D;standalone, port&#x3D;6379.</span><br><span class="line">redis_1  | 1:M 20 Aug 2020 16:46:45.290 # WARNING: The TCP backlog setting of 511 cannot be enforced because &#x2F;proc&#x2F;sys&#x2F;net&#x2F;core&#x2F;somaxconn is set to the lower value of 128.</span><br><span class="line">redis_1  | 1:M 20 Aug 2020 16:46:45.290 # Server initialized</span><br><span class="line">redis_1  | 1:M 20 Aug 2020 16:46:45.290 # WARNING overcommit_memory is set to 0! Background save may fail under low memory condition. To fix this issue add &#39;vm.overcommit_memory &#x3D; 1&#39; to &#x2F;etc&#x2F;sysctl.conf and then reboot or run the command &#39;sysctl vm.overcommit_memory&#x3D;1&#39; for this to take effect.</span><br><span class="line">redis_1  | 1:M 20 Aug 2020 16:46:45.290 # WARNING you have Transparent Huge Pages (THP) support enabled in your kernel. This will create latency and memory usage issues with Redis. To fix this issue run the command &#39;echo never &gt; &#x2F;sys&#x2F;kernel&#x2F;mm&#x2F;transparent_hugepage&#x2F;enabled&#39; as root, and add it to your &#x2F;etc&#x2F;rc.local in order to retain the setting after a reboot. Redis must be restarted after THP is disabled.</span><br><span class="line">redis_1  | 1:M 20 Aug 2020 16:46:45.291 * Ready to accept connections</span><br><span class="line">web_1    |  * Serving Flask app &quot;app&quot; (lazy loading)</span><br><span class="line">web_1    |  * Environment: production</span><br><span class="line">web_1    |    WARNING: This is a development server. Do not use it in a production deployment.</span><br><span class="line">web_1    |    Use a production WSGI server instead.</span><br><span class="line">web_1    |  * Debug mode: on</span><br><span class="line">web_1    |  * Running on http:&#x2F;&#x2F;0.0.0.0:5000&#x2F; (Press CTRL+C to quit)</span><br><span class="line">web_1    |  * Restarting with stat</span><br><span class="line">web_1    |  * Debugger is active!</span><br><span class="line">web_1    |  * Debugger PIN: 290-279-909</span><br></pre></td></tr></table></figure>

<p>如果要后台运行的话</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>

<p><img src="http://img.ljh666.xyz/img/20200821005135.png"></p>
<p>刷新浏览器数值会增加</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# docker image ls</span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">test_web            latest              e1d437e52801        6 minutes ago       84.5 MB</span><br><span class="line">&lt;none&gt;              &lt;none&gt;              11d309d27c40        15 minutes ago      72.9 MB</span><br><span class="line">docker.io&#x2F;redis     alpine              c7b388ce3d39        4 weeks ago         32.1 MB</span><br><span class="line">docker.io&#x2F;python    3.4-alpine          c06adcf62f6e        17 months ago       72.9 MB</span><br></pre></td></tr></table></figure>

<p>停止服务</p>
<p>可以在项目路径下使用docker-composedown命令停止服务，也可以在终端上按Ctrl+C键停止当前启动着的应用。</p>
<h3 id="将数据持久化"><a href="#将数据持久化" class="headerlink" title="将数据持久化"></a>将数据持久化</h3><p>编辑docker-compose.yml文件, 让容器目录映射到宿主机目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@master test]# vim docker-compose.yml </span><br><span class="line"></span><br><span class="line">version: &#39;3&#39;</span><br><span class="line">services:</span><br><span class="line">        web:</span><br><span class="line">                build: .</span><br><span class="line">                ports:</span><br><span class="line">                 - &quot;5000:5000&quot;</span><br><span class="line">                volumes:</span><br><span class="line">                 - .:&#x2F;code</span><br><span class="line">        redis:</span><br><span class="line">                image: &quot;redis:alpine&quot;</span><br></pre></td></tr></table></figure>

<p>新的volumes键将当前路径（项目路径）与容器中的/code路径挂载到一起，允许用户及时修改代码而不用重新构建镜像。</p>
<p>重建服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up</span><br></pre></td></tr></table></figure>

<p><img src="http://img.ljh666.xyz/img/20200821005855.png"></p>
<p>可以看到上次开启服务的记录保留着</p>
<p>因为应用程序的代码通过volume挂载到容器中，你可以更改其代码并立即查看更改，而不必重新生成镜像。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim app.py</span><br><span class="line"></span><br><span class="line">return &#39;Hello Worlddddddddddddddd! I have been seen &#123;&#125; times.\n&#39;.format(count)</span><br></pre></td></tr></table></figure>

<p>直接刷新网页</p>
<p><img src="http://img.ljh666.xyz/img/20200821010117.png"></p>
<h2 id="结束"><a href="#结束" class="headerlink" title="结束"></a>结束</h2>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.ljh.xyz/2020/08/21/Docker%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92[Docker%20compose]/" data-id="ckkzd08h400027ou1b5lpgszk" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Centos/" rel="tag">Centos</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Docker/" rel="tag">Docker</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Docker-Compose/" rel="tag">Docker-Compose</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux/" rel="tag">Linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%BA%91%E8%AE%A1%E7%AE%97%E4%B8%AD%E7%BA%A7/" rel="tag">云计算中级</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92/" rel="tag">容器编排</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-配置国内yum源" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/08/20/%E9%85%8D%E7%BD%AE%E5%9B%BD%E5%86%85yum%E6%BA%90/" class="article-date">
  <time datetime="2020-08-19T16:01:18.000Z" itemprop="datePublished">2020-08-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/08/20/%E9%85%8D%E7%BD%AE%E5%9B%BD%E5%86%85yum%E6%BA%90/">配置国内的yum源</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="配置国内的yum源"><a href="#配置国内的yum源" class="headerlink" title="配置国内的yum源"></a>配置国内的yum源</h1><h2 id="网易源"><a href="#网易源" class="headerlink" title="网易源"></a>网易源</h2><p>安装163的base源</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http:&#x2F;&#x2F;mirrors.163.com&#x2F;.help&#x2F;CentOS7-Base-163.repo</span><br></pre></td></tr></table></figure>

<p>网易没有epel源</p>
<h2 id="阿里源"><a href="#阿里源" class="headerlink" title="阿里源"></a>阿里源</h2><p>查看网页</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://developer.aliyun.com/mirror/epel?spm=a2c6h.13651102.0.0.3e221b11KHdS03">https://developer.aliyun.com/mirror/epel?spm=a2c6h.13651102.0.0.3e221b11KHdS03</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.aliyun.com/mirror/">https://developer.aliyun.com/mirror/</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.ljh.xyz/2020/08/20/%E9%85%8D%E7%BD%AE%E5%9B%BD%E5%86%85yum%E6%BA%90/" data-id="ckkzd08i600147ou1epqa4zqv" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Centos/" rel="tag">Centos</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux/" rel="tag">Linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/yum%E6%BA%90/" rel="tag">yum源</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%BA%91%E8%AE%A1%E7%AE%97%E4%B8%AD%E7%BA%A7/" rel="tag">云计算中级</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-安装Docker" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/08/18/%E5%AE%89%E8%A3%85Docker/" class="article-date">
  <time datetime="2020-08-18T05:01:18.000Z" itemprop="datePublished">2020-08-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/08/18/%E5%AE%89%E8%A3%85Docker/">安装Docker</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="安装Docker"><a href="#安装Docker" class="headerlink" title="安装Docker"></a>安装Docker</h1><h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><h3 id="清空防火墙规则"><a href="#清空防火墙规则" class="headerlink" title="清空防火墙规则"></a>清空防火墙规则</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">iptables -F</span><br><span class="line">iptables -X</span><br><span class="line">iptables -Z</span><br><span class="line">&#x2F;usr&#x2F;sbin&#x2F;iptables-save</span><br></pre></td></tr></table></figure>

<h3 id="永久关闭SELinux"><a href="#永久关闭SELinux" class="headerlink" title="永久关闭SELinux"></a>永久关闭SELinux</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sed -i &#39;s&#x2F;SELINUX&#x3D;enforcing&#x2F;SELINUX&#x3D;disabled&#x2F;g&#39; &#x2F;etc&#x2F;selinux&#x2F;config</span><br><span class="line">reboot                 ## 重启生效</span><br></pre></td></tr></table></figure>

<h3 id="关闭Swap交换区-提高docker性能"><a href="#关闭Swap交换区-提高docker性能" class="headerlink" title="关闭Swap交换区(提高docker性能)"></a>关闭Swap交换区(提高docker性能)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">swapoff -a</span><br><span class="line">sed -i &quot;s&#x2F;\&#x2F;dev\&#x2F;mapper\&#x2F;centos-swap&#x2F;\#\&#x2F;dev&#x2F;mapper\&#x2F;centos-swap&#x2F;g&quot; &#x2F;etc&#x2F;fstab</span><br></pre></td></tr></table></figure>

<p>查看swap交换区为零</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">free -m</span><br><span class="line">或者</span><br><span class="line">top</span><br><span class="line">或者</span><br><span class="line">df -h</span><br><span class="line">或者</span><br><span class="line">fdisk -l</span><br></pre></td></tr></table></figure>

<h3 id="开启路由转发"><a href="#开启路由转发" class="headerlink" title="开启路由转发"></a>开启路由转发</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;&gt;&#x2F;etc&#x2F;sysctl.conf&lt;&lt;EOF</span><br><span class="line">net.ipv4.ip_forward&#x3D;1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables&#x3D;1</span><br><span class="line">net.bridge.bridge-nf-call-iptables&#x3D;1</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">modprobe br_netfilter ##自动处理可载入模块br_netfilter</span><br></pre></td></tr></table></figure>

<h3 id="配置阿里的docker源"><a href="#配置阿里的docker源" class="headerlink" title="配置阿里的docker源"></a>配置阿里的docker源</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum-config-manager --add-repo https:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;docker-ce&#x2F;linux&#x2F;centos&#x2F;docker-ce.repo</span><br></pre></td></tr></table></figure>

<h2 id="安装Docker-1"><a href="#安装Docker-1" class="headerlink" title="安装Docker"></a>安装Docker</h2><p>查看可用软件包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum list docker-ce --showduplicates | sort -r</span><br></pre></td></tr></table></figure>

<p>安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install docker-ce  ##默认yum安装最新版本</span><br></pre></td></tr></table></figure>

<h2 id="启动Docker"><a href="#启动Docker" class="headerlink" title="启动Docker"></a>启动Docker</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br><span class="line">systemctl enable docker</span><br><span class="line">docker info</span><br></pre></td></tr></table></figure>

<h2 id="结束"><a href="#结束" class="headerlink" title="结束"></a>结束</h2><h2 id="配置docker软件仓库"><a href="#配置docker软件仓库" class="headerlink" title="配置docker软件仓库"></a>配置docker软件仓库</h2><p>添加国内docker软件仓库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@node2 ~]# vim &#x2F;etc&#x2F;docker&#x2F;daemon.json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">        &quot;registry-mirrors&quot;: [&quot;http:&#x2F;&#x2F;hub-mirror.c.163.com&quot;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>添加国内阿里docker软件仓库</p>
<p>添加阿里的docker仓库需要注册</p>
<p><img src="http://img.ljh666.xyz/img/20200818220037.png"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@node2 ~]# vim &#x2F;etc&#x2F;docker&#x2F;daemon.json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">        &quot;registry-mirrors&quot;: [&quot;http:&#x2F;&#x2F;hub-mirror.c.163.com&quot;,&quot;https:&#x2F;&#x2F;gjao6nys.mirror.aliyuncs.com&quot;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>








      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.ljh.xyz/2020/08/18/%E5%AE%89%E8%A3%85Docker/" data-id="ckkzd08hl000f7ou104tp4rzs" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Centos/" rel="tag">Centos</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux/" rel="tag">Linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/docker/" rel="tag">docker</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%BA%91%E8%AE%A1%E7%AE%97%E4%B8%AD%E7%BA%A7/" rel="tag">云计算中级</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-生成CA证书" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/08/18/%E7%94%9F%E6%88%90CA%E8%AF%81%E4%B9%A6/" class="article-date">
  <time datetime="2020-08-18T05:01:18.000Z" itemprop="datePublished">2020-08-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/08/18/%E7%94%9F%E6%88%90CA%E8%AF%81%E4%B9%A6/">openssl生成CA证书</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="生成CA证书"><a href="#生成CA证书" class="headerlink" title="生成CA证书"></a>生成CA证书</h1><h2 id="申请证书"><a href="#申请证书" class="headerlink" title="申请证书"></a>申请证书</h2><p>SSL常用于身份验证、数据加密等应用中，要使用SSL，我们密码有自己的证书。数字证书一般要向专业的认证公司(如VeriSign)申请，并且都是收费的，某些情况下，我们只是想使用加密的数据通信，而不在乎认证，这时就可以自己制作一个证书，自己制作一个证书，有两种方式，一种是Self Signed,另一种是自己制作一个CA，然后由这个CA,来发布我们需要的证书。下面分别介绍这两个方法。</p>
<p>这里只记录其中一个方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">生成自己的CA (Certificate Authority)</span><br><span class="line"></span><br><span class="line">CA是证书的发布者，CA可以发布其他人的证书，把CA的证书加入系统信任的根证书后，由CA发布的证书也被系统所信任，所以，CA的key是必须小心保护的，一般都要加密保护，并且限制为root权限读写。</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">＃生成CA的key</span><br><span class="line"></span><br><span class="line">#openssl genrsa -des3 -out ca.key 4096</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">#生成CA的证书</span><br><span class="line"></span><br><span class="line">#openssl req -new -x509 -days 365 -key ca.key -out ca.crt</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">#生成我们的key和CSR这两步与上面Self Signed中是一样的</span><br><span class="line"></span><br><span class="line">#openssl genrsa -des3 -out myserver.key 4096</span><br><span class="line"></span><br><span class="line">#openssl req -new -key myserver.key -out myserver.csr</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">#使用ca的证书和key，生成我们的证书</span><br><span class="line"></span><br><span class="line">#这里的set_serial指明了证书的序号，如果证书过期了(365天后)，</span><br><span class="line"></span><br><span class="line">#或者证书key泄漏了，需要重新发证的时候，就要加1</span><br><span class="line"></span><br><span class="line">#openssl x509 -req -days 365 -in myserver.csr -CA ca.crt -CAkey ca.key -set_serial 01 -out myserver.crt</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>查看证书</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">#查看KEY信息</span><br><span class="line"></span><br><span class="line">#openssl rsa -noout -text -in myserver.key</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">#查看CSR信息</span><br><span class="line"></span><br><span class="line">#openssl req -noout -text -in myserver.csr</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">#查看证书信息</span><br><span class="line"></span><br><span class="line">#openssl x509 -noout -text -in ca.crt</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">#验证证书</span><br><span class="line"></span><br><span class="line">#会提示self signed</span><br><span class="line"></span><br><span class="line">#openssl verify selfsign.crt</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">#因为myserver.crt是幅ca.crt发布的，所以会验证成功</span><br><span class="line"></span><br><span class="line">#openssl verify -CAfile ca.crt myserver.crt</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">去掉key的密码保护</span><br><span class="line"></span><br><span class="line">#有时候每次都要输入密码太繁琐了,可以把Key的保护密码去掉</span><br><span class="line"></span><br><span class="line">#openssl rsa -in myserver.key -out server.key.insecure</span><br></pre></td></tr></table></figure>



<h2 id="key、csr、crt-区别"><a href="#key、csr、crt-区别" class="headerlink" title="key、csr、crt 区别"></a>key、csr、crt 区别</h2><p>key通常指私钥<br>CSR 是Certificate Signing Request的缩写，即证书签名申请，这不是证书，这是要求CA给证书签名的一种正是申请，该申请包含申请证书的实体的公钥及该实体店某些信息。该数据将成为证书的一部分。CSR始终使用它携带的公钥所对应的私钥进行签名。<br>CRT 即 certificate的缩写，即证书<br>TLS：传输层安全协议 Transport Layer Security的缩写<br>SSL：安全套接字层 Secure Socket Layer的缩写<br>X.509 是一种证书格式.对X.509证书来说，认证者总是CA或由CA指定的人，一份X.509证书是一些标准字段的集合，这些字段包含有关用户或设备及其相应公钥的信息。</p>
<p>X.509的证书文件，一般以.crt结尾，根据该文件的内容编码格式，可以分为以下二种格式：</p>
<p>PEM - Privacy Enhanced Mail,打开看文本格式,以”—–BEGIN…”开头, “—–END…”结尾,内容是BASE64编码</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.ljh.xyz/2020/08/18/%E7%94%9F%E6%88%90CA%E8%AF%81%E4%B9%A6/" data-id="ckkzd08hw000p7ou1b6cr11f8" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Centos/" rel="tag">Centos</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux/" rel="tag">Linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/docker/" rel="tag">docker</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/openssl/" rel="tag">openssl</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%BA%91%E8%AE%A1%E7%AE%97%E4%B8%AD%E7%BA%A7/" rel="tag">云计算中级</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%91%BD%E4%BB%A4%E8%A7%A3%E6%9E%90/" rel="tag">命令解析</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%AF%86%E9%92%A5/" rel="tag">密钥</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-分布式存储的三种类型" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/08/16/%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8%E7%9A%84%E4%B8%89%E7%A7%8D%E7%B1%BB%E5%9E%8B/" class="article-date">
  <time datetime="2020-08-15T16:01:18.000Z" itemprop="datePublished">2020-08-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/08/16/%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8%E7%9A%84%E4%B8%89%E7%A7%8D%E7%B1%BB%E5%9E%8B/">分布式存储的三种类型</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="分布式存储的三种类型"><a href="#分布式存储的三种类型" class="headerlink" title="分布式存储的三种类型"></a>分布式存储的三种类型</h1><h2 id="查阅文献："><a href="#查阅文献：" class="headerlink" title="查阅文献："></a>查阅文献：</h2><p><a target="_blank" rel="noopener" href="https://link.jianshu.com/?t=http://www.infoq.com/cn/articles/virtual-forum-three-basic-issues-about-distributed-storage">有关分布式存储的三个基本问题</a></p>
<p><a target="_blank" rel="noopener" href="https://link.jianshu.com/?t=http://www.testlab.com.cn/Index/article/id/1082.html">文件系统vs对象存储——选型和趋势</a></p>
<p><a target="_blank" rel="noopener" href="https://link.jianshu.com/?t=https://www.zhihu.com/question/21536660">块存储、文件存储、对象存储这三者的本质差别是什么</a></p>
<h2 id="三种存储方式的比较与介绍"><a href="#三种存储方式的比较与介绍" class="headerlink" title="三种存储方式的比较与介绍:"></a>三种存储方式的比较与介绍:</h2><p>分布式存储的应用场景相对于其存储接口，现在流行分为三种:</p>
<p>对象存储: 也就是通常意义的键值存储，其接口就是简单的GET、PUT、DEL和其他扩展，如七牛、又拍、Swift、S3</p>
<p>块存储: 这种接口通常以QEMU Driver或者Kernel Module的方式存在，这种接口需要实现Linux的Block Device的接口或者QEMU提供的Block Driver接口，如Sheepdog，AWS的EBS，青云的云硬盘和阿里云的盘古系统，还有Ceph的RBD（RBD是Ceph面向块存储的接口）</p>
<p>文件存储: 通常意义是支持POSIX接口，它跟传统的文件系统如Ext4是一个类型的，但区别在于分布式存储提供了并行化的能力，如Ceph的CephFS(CephFS是Ceph面向文件存储的接口)，但是有时候又会把GFS，HDFS这种非POSIX接口的类文件存储接口归入此类。</p>
<p>作者：<em>Hook</em><br>链接：<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/907b25e79c3d">https://www.jianshu.com/p/907b25e79c3d</a><br>来源：简书<br>著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.ljh.xyz/2020/08/16/%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8%E7%9A%84%E4%B8%89%E7%A7%8D%E7%B1%BB%E5%9E%8B/" data-id="ckkzd08he00097ou18nsch9hz" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Centos/" rel="tag">Centos</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux/" rel="tag">Linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/openstack/" rel="tag">openstack</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%BA%91%E8%AE%A1%E7%AE%97%E4%B8%AD%E7%BA%A7/" rel="tag">云计算中级</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8/" rel="tag">分布式存储</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%A7%81%E6%9C%89%E4%BA%91/" rel="tag">私有云</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-构建ceph分布式存储系统" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/08/16/%E6%9E%84%E5%BB%BAceph%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8%E7%B3%BB%E7%BB%9F/" class="article-date">
  <time datetime="2020-08-15T16:01:18.000Z" itemprop="datePublished">2020-08-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/08/16/%E6%9E%84%E5%BB%BAceph%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8%E7%B3%BB%E7%BB%9F/">构建ceph分布式存储系统</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="构建ceph分布式存储系统"><a href="#构建ceph分布式存储系统" class="headerlink" title="构建ceph分布式存储系统"></a>构建ceph分布式存储系统</h1><h2 id="查阅文献"><a href="#查阅文献" class="headerlink" title="查阅文献"></a>查阅文献</h2><p><a target="_blank" rel="noopener" href="http://www.ljh666.xyz/2020/08/16/%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8%E7%9A%84%E4%B8%89%E7%A7%8D%E7%B1%BB%E5%9E%8B/">分布式存储的三种类型</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.51cto.com/haoyou168/83021">linux系统下的磁盘分区</a></p>
<p><a target="_blank" rel="noopener" href="http://docs.ceph.org.cn/rbd/rados-rbd-cmds/">块设备命令rbd</a></p>
<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><blockquote>
<p>Ceph与Swift另外一种最大的不同还在于客户端访问对象存储系统方式。 在Swift中，客户端必须联到Swift网关，这样有出现单点故障的可能。 为了解决这一问题，许多Swift环境为Swift网关实现了高可用性。</p>
<p>Ceph的存储节点上运行着OSD，Ceph通过OSD能获得存储拓扑图，能通过OSD收集到二进制对象最后找到原始数据，别的部分都是访问运行在客户端上的对象的主要组件，Ceph访问存储的方式不只有单个入口，所以与Swift相比更加灵活。</p>
</blockquote>
<blockquote>
<p>Swift是由Rackspace开发的用来为云计算提供可扩展存储的项目。它是为云而开发的，云原生的，所以它主要的访问方法RESTful API。应用程序绕开操作系统直接去Swif对接。这样做的好处是在云环境中使用时非常方便，但在访问云外的Swift存储时就比较麻烦了。</p>
</blockquote>
<h2 id="补充知识"><a href="#补充知识" class="headerlink" title="补充知识"></a>补充知识</h2><ul>
<li>fdisk只能用于MBR分区，gdisk,parted可以用于GPT分区。</li>
<li>fdisk大多数运维工作人员已经习惯这个交互模式。</li>
<li>parted命令在创建删除分区使用命令比较方便，但是功能不是太完善，没有备份还原命令。</li>
<li>gdisk在分区上命令和fdisk风格一样， 使用方便，学习难度低且功能强大，推荐使用。</li>
</ul>
<h2 id="环境介绍"><a href="#环境介绍" class="headerlink" title="环境介绍"></a>环境介绍</h2><table>
<thead>
<tr>
<th align="center">IP地址</th>
<th>主机名</th>
<th>节点</th>
</tr>
</thead>
<tbody><tr>
<td align="center">10.10.10.11</td>
<td>node1</td>
<td>Monitor/OSD</td>
</tr>
<tr>
<td align="center">10.10.10.12</td>
<td>node2</td>
<td>OSD</td>
</tr>
<tr>
<td align="center">10.10.10.13</td>
<td>node3</td>
<td>OSD/ceph-client</td>
</tr>
</tbody></table>
<p>配置网易的yum源(或者用国内的提供的ceph官方源)</p>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><p>三个节点都添加一块20G硬盘</p>
<p>修改主机名</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hostnamectl set-hostname node1 ##三台都要设置</span><br></pre></td></tr></table></figure>



<p>配置yum源(此实验使用本地的两个镜像源)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 images]# vim &#x2F;etc&#x2F;yum.repos.d&#x2F;local.repo </span><br><span class="line"></span><br><span class="line">[xiandian]</span><br><span class="line">name&#x3D;xiandian</span><br><span class="line">baseurl&#x3D;file:&#x2F;&#x2F;&#x2F;media&#x2F;cdrom&#x2F;iaas-repo&#x2F;</span><br><span class="line">gpgcheck&#x3D;0</span><br><span class="line">enable&#x3D;1</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@node2 images]# vim &#x2F;etc&#x2F;yum.repos.d&#x2F;local.repo</span><br><span class="line"></span><br><span class="line">[xiandian]</span><br><span class="line">name&#x3D;xiandian</span><br><span class="line">baseurl&#x3D;ftp:&#x2F;&#x2F;node1&#x2F;</span><br><span class="line">gpgcheck&#x3D;0</span><br><span class="line">enable&#x3D;1</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@node3 images]# vim &#x2F;etc&#x2F;yum.repos.d&#x2F;local.repo</span><br><span class="line"></span><br><span class="line">[xiandian]</span><br><span class="line">name&#x3D;xiandian</span><br><span class="line">baseurl&#x3D;ftp:&#x2F;&#x2F;node1&#x2F;</span><br><span class="line">gpgcheck&#x3D;0</span><br><span class="line">enable&#x3D;1</span><br></pre></td></tr></table></figure>



<p>修改/etc/hosts文件, 添加解析</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#ceph</span><br><span class="line">10.10.10.11 node1</span><br><span class="line">10.10.10.12 node2</span><br><span class="line">10.10.10.13 node3</span><br></pre></td></tr></table></figure>



<h2 id="安装ceph"><a href="#安装ceph" class="headerlink" title="安装ceph"></a>安装ceph</h2><p>要部署Ceph集群，需要使用ceph-deploy工具在3台虚拟机上安装和配置Ceph。ceph-deploy是Ceph软件定义存储系统的一部分，用来方便地配置和管理Ceph存储集群。</p>
<p>在node1节点安装ceph-deploy, 通过node1部署其他节点的ceph</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install ceph-deploy</span><br></pre></td></tr></table></figure>

<p>创建用来存放ceph-deploy产生文件的目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir &#x2F;etc&#x2F;ceph</span><br><span class="line">cd &#x2F;etc&#x2F;ceph</span><br></pre></td></tr></table></figure>

<p>初始化生成ceph集群</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph-deploy new node1</span><br></pre></td></tr></table></figure>

<blockquote>
<p>其中node1为主机名 </p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ceph]# ls</span><br><span class="line">ceph.conf  ceph.log  ceph.mon.keyring</span><br></pre></td></tr></table></figure>

<p>使用ceph-deploy工具在所有节点上安装ceph二进制软件包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph-deploy install node1 node2 node3</span><br></pre></td></tr></table></figure>

<p>但这里报错了, 原因是找不到ceph-release的安装包</p>
<p>使用网易的ceph源重新安装ceph-deploy(目前源为163源加网易ceph源)</p>
<p>在各节点查看是否安装成功</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph -v</span><br></pre></td></tr></table></figure>

<p>在node1节点创建一个monitor</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ceph]# ceph-deploy --overwrite-conf mon create-initial</span><br></pre></td></tr></table></figure>

<blockquote>
<p>–overwrite-conf</p>
<p>覆盖远程主机上的现有conf文件（如果存在）。</p>
</blockquote>
<p>Monitor创建成功后，检查集群的状态，这个时候Ceph集群并不处于健康状态。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph -s</span><br></pre></td></tr></table></figure>

<h2 id="创建OSD"><a href="#创建OSD" class="headerlink" title="创建OSD"></a>创建OSD</h2><p>列出ceph-node1上所有的可用磁盘。(不看也没事, 用lsblk也一样)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph-deploy disk list node1 </span><br></pre></td></tr></table></figure>

<p>创建共享磁盘，3个节点都要执行。首先对系统上的空闲硬盘进行分区、格式化、挂载的操作。</p>
<p>使用parted工具，对/dev/sdd进行分区，首先使用mklabel命令改变该盘的卷标为gpt，然后使用mkpart命令，将所有的空间都分给/dev/sdd</p>
<p><strong>操作例子:</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ceph]# parted &#x2F;dev&#x2F;sdd</span><br><span class="line">GNU Parted 3.1</span><br><span class="line">使用 &#x2F;dev&#x2F;sdd</span><br><span class="line">Welcome to GNU Parted! Type &#39;help&#39; to view a list of commands.</span><br><span class="line">(parted) p                                                                </span><br><span class="line">Model: VMware, VMware Virtual S (scsi)</span><br><span class="line">Disk &#x2F;dev&#x2F;sdd: 21.5GB</span><br><span class="line">Sector size (logical&#x2F;physical): 512B&#x2F;512B</span><br><span class="line">Partition Table: unkown</span><br><span class="line">Disk Flags: </span><br><span class="line"></span><br><span class="line">Number  Start  End  Size  Type  File system  标志</span><br><span class="line"></span><br><span class="line">(parted) mklabel   ####创建分区标志</span><br><span class="line">新的磁盘标签类型？ gpt                                                    </span><br><span class="line">警告: The existing disk label on &#x2F;dev&#x2F;sdd will be destroyed and all data on this disk will</span><br><span class="line">be lost. Do you want to continue?</span><br><span class="line">是&#x2F;Yes&#x2F;否&#x2F;No? yes                                                         </span><br><span class="line">(parted) p                                                                </span><br><span class="line">Model: VMware, VMware Virtual S (scsi)</span><br><span class="line">Disk &#x2F;dev&#x2F;sdd: 21.5GB</span><br><span class="line">Sector size (logical&#x2F;physical): 512B&#x2F;512B</span><br><span class="line">Partition Table: gpt</span><br><span class="line">Disk Flags: </span><br><span class="line"></span><br><span class="line">Number  Start  End  Size  File system  Name  标志</span><br><span class="line"></span><br><span class="line">(parted) mkpart          ####创建分区                                                 </span><br><span class="line">分区名称？  []?                                                           </span><br><span class="line">文件系统类型？  [ext2]?                                                   </span><br><span class="line">起始点？ 0%                                                               </span><br><span class="line">结束点？ 100%                                                             </span><br><span class="line">(parted) p                                                                </span><br><span class="line">Model: VMware, VMware Virtual S (scsi)</span><br><span class="line">Disk &#x2F;dev&#x2F;sdd: 21.5GB</span><br><span class="line">Sector size (logical&#x2F;physical): 512B&#x2F;512B</span><br><span class="line">Partition Table: gpt</span><br><span class="line">Disk Flags: </span><br><span class="line"></span><br><span class="line">Number  Start   End     Size    File system  Name  标志</span><br><span class="line"> 1      1049kB  21.5GB  21.5GB</span><br><span class="line"></span><br><span class="line">(parted) q                                                                </span><br><span class="line">信息: You may need to update &#x2F;etc&#x2F;fstab.</span><br></pre></td></tr></table></figure>

<p>可以使用lsblk命令，查看分区情况：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ceph]# lsblk                                                  </span><br><span class="line">NAME            MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT</span><br><span class="line">sda               8:0    0  100G  0 disk </span><br><span class="line">├─sda1            8:1    0    1G  0 part &#x2F;boot</span><br><span class="line">└─sda2            8:2    0   99G  0 part </span><br><span class="line">  ├─centos-root 253:0    0   50G  0 lvm  &#x2F;</span><br><span class="line">  ├─centos-swap 253:1    0    2G  0 lvm  [SWAP]</span><br><span class="line">  └─centos-home 253:2    0   47G  0 lvm  &#x2F;home</span><br><span class="line">sdb               8:16   0   20G  0 disk </span><br><span class="line">├─sdb1            8:17   0    5G  0 part </span><br><span class="line">├─sdb2            8:18   0    5G  0 part </span><br><span class="line">└─sdb3            8:19   0    5G  0 part </span><br><span class="line">sdc               8:32   0   20G  0 disk </span><br><span class="line">sdd               8:48   0   20G  0 disk </span><br><span class="line">└─sdd1  ##创建的分区8:49   0   20G  0 part </span><br><span class="line">sr0              11:0    1 10.3G  0 rom  &#x2F;mnt&#x2F;cdrom</span><br><span class="line">loop0             7:0    0  2.7G  0 loop &#x2F;media&#x2F;cdrom</span><br></pre></td></tr></table></figure>

<p>接下来使用命令对分区进行格式化，创建一个目录叫/opt/osd1，挂载分区到目录，最后</p>
<p> 将该目录的权限提升到777。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ceph]# mkfs.xfs &#x2F;dev&#x2F;sdd1</span><br><span class="line">meta-data&#x3D;&#x2F;dev&#x2F;sdd1              isize&#x3D;512    agcount&#x3D;4, agsize&#x3D;1310592 blks</span><br><span class="line">         &#x3D;                       sectsz&#x3D;512   attr&#x3D;2, projid32bit&#x3D;1</span><br><span class="line">         &#x3D;                       crc&#x3D;1        finobt&#x3D;0, sparse&#x3D;0</span><br><span class="line">data     &#x3D;                       bsize&#x3D;4096   blocks&#x3D;5242368, imaxpct&#x3D;25</span><br><span class="line">         &#x3D;                       sunit&#x3D;0      swidth&#x3D;0 blks</span><br><span class="line">naming   &#x3D;version 2              bsize&#x3D;4096   ascii-ci&#x3D;0 ftype&#x3D;1</span><br><span class="line">log      &#x3D;internal log           bsize&#x3D;4096   blocks&#x3D;2560, version&#x3D;2</span><br><span class="line">         &#x3D;                       sectsz&#x3D;512   sunit&#x3D;0 blks, lazy-count&#x3D;1</span><br><span class="line">realtime &#x3D;none                   extsz&#x3D;4096   blocks&#x3D;0, rtextents&#x3D;0</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ceph]# mkdir &#x2F;opt&#x2F;osd1</span><br><span class="line">[root@node1 ceph]# mount &#x2F;dev&#x2F;sdd1 &#x2F;opt&#x2F;osd1</span><br><span class="line">[root@node1 ceph]# df -h</span><br><span class="line">文件系统                 容量  已用  可用 已用% 挂载点</span><br><span class="line">devtmpfs                 898M     0  898M    0% &#x2F;dev</span><br><span class="line">tmpfs                    910M     0  910M    0% &#x2F;dev&#x2F;shm</span><br><span class="line">tmpfs                    910M  9.8M  900M    2% &#x2F;run</span><br><span class="line">tmpfs                    910M     0  910M    0% &#x2F;sys&#x2F;fs&#x2F;cgroup</span><br><span class="line">&#x2F;dev&#x2F;mapper&#x2F;centos-root   50G  5.3G   45G   11% &#x2F;</span><br><span class="line">&#x2F;dev&#x2F;sr0                  11G   11G     0  100% &#x2F;mnt&#x2F;cdrom</span><br><span class="line">&#x2F;dev&#x2F;loop0               2.7G  2.7G     0  100% &#x2F;media&#x2F;cdrom</span><br><span class="line">&#x2F;dev&#x2F;mapper&#x2F;centos-home   47G   33M   47G    1% &#x2F;home</span><br><span class="line">&#x2F;dev&#x2F;sda1               1014M  150M  865M   15% &#x2F;boot</span><br><span class="line">overlay                   50G  5.3G   45G   11% &#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;09ad5cd00825e0cfd09690b6b5d64034055924b3ab1a83be414f67f748cd08ac&#x2F;merged</span><br><span class="line">shm                       64M     0   64M    0% &#x2F;var&#x2F;lib&#x2F;docker&#x2F;containers&#x2F;994a0e297cae8d2b517a13d69b9d8c19265cee622d49211f231ea9286526b523&#x2F;shm</span><br><span class="line">tmpfs                    182M     0  182M    0% &#x2F;run&#x2F;user&#x2F;0</span><br><span class="line">&#x2F;dev&#x2F;sdd1                 20G   33M   20G    1% &#x2F;opt&#x2F;osd1</span><br><span class="line">[root@node1 ceph]# chmod 777 &#x2F;opt&#x2F;osd1</span><br></pre></td></tr></table></figure>

<p><strong>另外两个节点做相同操作</strong></p>
<h2 id="激活OSD"><a href="#激活OSD" class="headerlink" title="激活OSD"></a>激活OSD</h2><h3 id="初始化上面创建的osd"><a href="#初始化上面创建的osd" class="headerlink" title="初始化上面创建的osd"></a>初始化上面创建的osd</h3><p>在node1节点运行命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ceph]# ceph-deploy osd prepare node1:&#x2F;opt&#x2F;osd1 node2:&#x2F;opt&#x2F;osd1 node3:&#x2F;opt&#x2F;osd1 </span><br></pre></td></tr></table></figure>

<h3 id="激活OSD节点"><a href="#激活OSD节点" class="headerlink" title="激活OSD节点"></a>激活OSD节点</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ceph]# ceph-deploy osd activate node1:&#x2F;opt&#x2F;osd1  node2:&#x2F;opt&#x2F;osd1  node3:&#x2F;opt&#x2F;osd1</span><br></pre></td></tr></table></figure>

<h2 id="检查ceph集群状态"><a href="#检查ceph集群状态" class="headerlink" title="检查ceph集群状态"></a>检查ceph集群状态</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ceph]# ceph -s</span><br><span class="line">    cluster 13d859cc-a311-4152-9ba1-a2542b7a2773</span><br><span class="line">     health HEALTH_OK   ####显示状态为正常</span><br><span class="line">     monmap e1: 1 mons at &#123;node1&#x3D;10.10.10.11:6789&#x2F;0&#125;</span><br><span class="line">            election epoch 1, quorum 0 node1</span><br><span class="line">     osdmap e13: 3 osds: 3 up, 3 in</span><br><span class="line">      pgmap v24: 64 pgs, 1 pools, 0 bytes data, 0 objects</span><br><span class="line">            15533 MB used, 45870 MB &#x2F; 61404 MB avail</span><br><span class="line">                  64 active+clean</span><br></pre></td></tr></table></figure>

<p>开放权限给其他节点，进行<strong>灾备处理</strong>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ceph]# ceph-deploy admin node&#123;1,2,3&#125; </span><br></pre></td></tr></table></figure>

<h2 id="Ceph集群运维"><a href="#Ceph集群运维" class="headerlink" title="Ceph集群运维"></a>Ceph集群运维</h2><p>检查ceph安装状态</p>
<p>观察集群的健康状况</p>
<p>检查ceph monitor仲裁状态</p>
<p>导出ceph monitor 信息</p>
<p>检查集群使用状态</p>
<p>检查ceph monitor; osd和PG(配置组)状态</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ceph]# ceph mon stat</span><br><span class="line">e1: 1 mons at &#123;node1&#x3D;10.10.10.11:6789&#x2F;0&#125;, election epoch 1, quorum 0 node1</span><br><span class="line">[root@node1 ceph]# ceph osd stat</span><br><span class="line">     osdmap e13: 3 osds: 3 up, 3 in</span><br><span class="line">[root@node1 ceph]# ceph pg stat</span><br><span class="line">v24: 64 pgs: 64 active+clean; 0 bytes data, 15533 MB used, 45870 MB &#x2F; 61404 MB avail</span><br></pre></td></tr></table></figure>

<p>列表PG</p>
<p>列表ceph存储池</p>
<p>检查osd的crush</p>
<p>列表群的认证秘钥</p>
<h2 id="Ceph集群的使用"><a href="#Ceph集群的使用" class="headerlink" title="Ceph集群的使用"></a>Ceph集群的使用</h2><p><code>rbd</code> 命令可用于创建、罗列、内省和删除块设备映像，也可克隆映像、创建快照、回滚快照、查看快照等等。 <code>rbd</code> 命令用法详情见 <a target="_blank" rel="noopener" href="http://docs.ceph.org.cn/man/8/rbd/">RBD – 管理 RADOS 块设备映像</a>。</p>
<p>由于提供的主机有限, 这里利用node3作为ceph-client</p>
<p>ceph-client做相同的准备工作(如果是一个新主机的话, 这里不用重复做了)</p>
<p>在ceph-node1上，用  ceph-deploy工具把Ceph 配置文件和  ceph.client.admin.keyring拷贝到ceph-client。ceph-deploy工具会把密钥环复制到/etc/ceph目录，要确保此密钥环文件有读权限（如sudo chmod +r /etc/ceph/ceph.client.admin.keyring）。&lt;—–(所以这里不用执行下面这些命令了)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph-deploy install node3</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ceph-deploy admin node3</span><br></pre></td></tr></table></figure>



<p>ceph客户端的使用</p>
<p>在ceph-client节点创建块设备, <strong>名字叫foo</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@node3 ~]# rbd create foo --size 1028 -m 10.10.10.11 -k &#x2F;etc&#x2F;ceph&#x2F;ceph.client.admin.keyring </span><br></pre></td></tr></table></figure>

<blockquote>
<p>-m: monitor</p>
<p>-k: keyring </p>
</blockquote>
<p>映射</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@node3 ~]# rbd map foo --name client.admin -m 10.10.10.11 -k &#x2F;etc&#x2F;ceph&#x2F;ceph.client.admin.keyring </span><br><span class="line"></span><br><span class="line">&#x2F;dev&#x2F;rbd0</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@node3 ~]# lsblk</span><br><span class="line">NAME            MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT</span><br><span class="line">sda               8:0    0  100G  0 disk </span><br><span class="line">├─sda1            8:1    0    1G  0 part &#x2F;boot</span><br><span class="line">└─sda2            8:2    0   99G  0 part </span><br><span class="line">  ├─centos-root 253:0    0   50G  0 lvm  &#x2F;</span><br><span class="line">  ├─centos-swap 253:1    0    2G  0 lvm  [SWAP]</span><br><span class="line">  └─centos-home 253:2    0   47G  0 lvm  &#x2F;home</span><br><span class="line">sdb               8:16   0   20G  0 disk </span><br><span class="line">sdc               8:32   0   20G  0 disk </span><br><span class="line">└─sdc1            8:33   0   20G  0 part &#x2F;opt&#x2F;osd1</span><br><span class="line">sr0              11:0    1 10.3G  0 rom  &#x2F;mnt&#x2F;cdrom</span><br><span class="line">rbd0  ##映射成功   252:0    0    1G  0 disk </span><br></pre></td></tr></table></figure>

<p>格式化&amp;挂载</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@node3 ~]# mount &#x2F;dev&#x2F;rbd0 &#x2F;mnt</span><br><span class="line">[root@node3 ~]# df -h</span><br><span class="line">文件系统                 容量  已用  可用 已用% 挂载点</span><br><span class="line">devtmpfs                 898M     0  898M    0% &#x2F;dev</span><br><span class="line">tmpfs                    910M     0  910M    0% &#x2F;dev&#x2F;shm</span><br><span class="line">tmpfs                    910M  9.6M  901M    2% &#x2F;run</span><br><span class="line">tmpfs                    910M     0  910M    0% &#x2F;sys&#x2F;fs&#x2F;cgroup</span><br><span class="line">&#x2F;dev&#x2F;mapper&#x2F;centos-root   50G  1.8G   49G    4% &#x2F;</span><br><span class="line">&#x2F;dev&#x2F;sda1               1014M  150M  865M   15% &#x2F;boot</span><br><span class="line">&#x2F;dev&#x2F;mapper&#x2F;centos-home   47G   33M   47G    1% &#x2F;home</span><br><span class="line">tmpfs                    182M     0  182M    0% &#x2F;run&#x2F;user&#x2F;0</span><br><span class="line">&#x2F;dev&#x2F;sdc1                 20G  5.1G   15G   26% &#x2F;opt&#x2F;osd1</span><br><span class="line">&#x2F;dev&#x2F;rbd0               1018M   33M  986M    4% &#x2F;mnt   ## 挂载成功</span><br></pre></td></tr></table></figure>

<p>创建块设备的顺序是，在ceph-client节点上使用rbd create命令创建一个块设备image，然后用rbd map命令把image映射为块设备，最后对映射出来的/dev/rbd0格式化并挂载。就可以当成普通了块设备使用了。</p>
<p>调整ceph块设备映像的大小</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rdb info foo</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rdb resize --size 2048 foo</span><br><span class="line">resizefs &#x2F;dev&#x2F;rdb0</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">df -h</span><br></pre></td></tr></table></figure>

<p>卸载块设备, 删除块设备</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">umount &#x2F;mnt</span><br><span class="line">rbd rm foo</span><br></pre></td></tr></table></figure>

<h2 id="结束"><a href="#结束" class="headerlink" title="结束"></a>结束</h2><h2 id="错误记录"><a href="#错误记录" class="headerlink" title="错误记录"></a>错误记录</h2><p>操作: 初始化生成ceph集群</p>
<p>错误:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@xserver1 ceph]# ceph-deploy new node1</span><br><span class="line">[ceph_deploy.conf][DEBUG ] found configuration file at: &#x2F;root&#x2F;.cephdeploy.conf</span><br><span class="line">[ceph_deploy.cli][INFO  ] Invoked (1.5.25): &#x2F;usr&#x2F;bin&#x2F;ceph-deploy new node1</span><br><span class="line">[ceph_deploy.new][DEBUG ] Creating new cluster named ceph</span><br><span class="line">[ceph_deploy.new][INFO  ] making sure passwordless SSH succeeds</span><br><span class="line">[ceph_deploy][ERROR ] Traceback (most recent call last):</span><br><span class="line">[ceph_deploy][ERROR ]   File &quot;&#x2F;usr&#x2F;lib&#x2F;python2.7&#x2F;site-packages&#x2F;ceph_deploy&#x2F;util&#x2F;decorators.py&quot;, line 69, in newfunc</span><br><span class="line">[ceph_deploy][ERROR ]     return f(*a, **kw)</span><br><span class="line">[ceph_deploy][ERROR ]   File &quot;&#x2F;usr&#x2F;lib&#x2F;python2.7&#x2F;site-packages&#x2F;ceph_deploy&#x2F;cli.py&quot;, line 162, in _main</span><br><span class="line">[ceph_deploy][ERROR ]     return args.func(args)</span><br><span class="line">[ceph_deploy][ERROR ]   File &quot;&#x2F;usr&#x2F;lib&#x2F;python2.7&#x2F;site-packages&#x2F;ceph_deploy&#x2F;new.py&quot;, line 141, in new</span><br><span class="line">[ceph_deploy][ERROR ]     ssh_copy_keys(host, args.username)</span><br><span class="line">[ceph_deploy][ERROR ]   File &quot;&#x2F;usr&#x2F;lib&#x2F;python2.7&#x2F;site-packages&#x2F;ceph_deploy&#x2F;new.py&quot;, line 35, in ssh_copy_keys</span><br><span class="line">[ceph_deploy][ERROR ]     if ssh.can_connect_passwordless(hostname):</span><br><span class="line">[ceph_deploy][ERROR ]   File &quot;&#x2F;usr&#x2F;lib&#x2F;python2.7&#x2F;site-packages&#x2F;ceph_deploy&#x2F;util&#x2F;ssh.py&quot;, line 15, in can_connect_passwordless</span><br><span class="line">[ceph_deploy][ERROR ]     if not remoto.connection.needs_ssh(hostname):</span><br><span class="line">[ceph_deploy][ERROR ] AttributeError: &#39;module&#39; object has no attribute &#39;needs_ssh&#39;</span><br><span class="line">[ceph_deploy][ERROR ] </span><br></pre></td></tr></table></figure>

<p>解决:</p>
<p>升级python的remote库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install --upgrade remoto</span><br></pre></td></tr></table></figure>

<p>查阅的文章:</p>
<ul>
<li><p><a target="_blank" rel="noopener" href="https://pypi.org/project/remoto/">https://pypi.org/project/remoto/</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://bugzilla.redhat.com/show_bug.cgi?id=1662496">https://bugzilla.redhat.com/show_bug.cgi?id=1662496</a></p>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.ljh.xyz/2020/08/16/%E6%9E%84%E5%BB%BAceph%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8%E7%B3%BB%E7%BB%9F/" data-id="ckkzd08hv000m7ou16m9fbs2q" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Centos/" rel="tag">Centos</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Ceph/" rel="tag">Ceph</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux/" rel="tag">Linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/openstack/" rel="tag">openstack</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%BA%91%E8%AE%A1%E7%AE%97%E4%B8%AD%E7%BA%A7/" rel="tag">云计算中级</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8/" rel="tag">分布式存储</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%A7%81%E6%9C%89%E4%BA%91/" rel="tag">私有云</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-ZooKeeper集群部署" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/08/06/ZooKeeper%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/" class="article-date">
  <time datetime="2020-08-06T11:31:18.000Z" itemprop="datePublished">2020-08-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/08/06/ZooKeeper%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/">ZooKeeper集群部署</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="ZooKeeper集群部署"><a href="#ZooKeeper集群部署" class="headerlink" title="ZooKeeper集群部署"></a>ZooKeeper集群部署</h1><h2 id="规划节点"><a href="#规划节点" class="headerlink" title="规划节点"></a>规划节点</h2><table>
<thead>
<tr>
<th align="center">IP</th>
<th align="center">主机名</th>
<th align="center">节点</th>
</tr>
</thead>
<tbody><tr>
<td align="center">10.10.10.101</td>
<td align="center">ZooKeeper1</td>
<td align="center">集群节点</td>
</tr>
<tr>
<td align="center">10.10.10.11</td>
<td align="center">ZooKeeper2</td>
<td align="center">集群节点</td>
</tr>
<tr>
<td align="center">10.10.10.12</td>
<td align="center">ZooKeeper3</td>
<td align="center">集群节点</td>
</tr>
</tbody></table>
<h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/warking/p/7565526.html">zoo.cfg详解</a></p>
<h2 id="安装JDK环境"><a href="#安装JDK环境" class="headerlink" title="安装JDK环境"></a>安装JDK环境</h2><p>在三个节点都安装JDK</p>
<p><a target="_blank" rel="noopener" href="https://www.oracle.com/java/technologies/javase/javase-jdk8-downloads.html">官网下载地址</a></p>
<p>这里使用yum安装</p>
<p>查看可用安装包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@mycat ~]# yum list | grep java-1.8.0</span><br><span class="line">java-1.8.0-openjdk.x86_64                 1:1.8.0.252.b09-2.el7_8      @updates </span><br><span class="line">java-1.8.0-openjdk-devel.x86_64           1:1.8.0.252.b09-2.el7_8      @updates </span><br><span class="line">java-1.8.0-openjdk-headless.x86_64        1:1.8.0.252.b09-2.el7_8      @updates </span><br><span class="line">java-1.8.0-openjdk.i686                   1:1.8.0.252.b09-2.el7_8      updates  </span><br><span class="line">java-1.8.0-openjdk-accessibility.i686     1:1.8.0.252.b09-2.el7_8      updates  </span><br><span class="line">java-1.8.0-openjdk-accessibility.x86_64   1:1.8.0.252.b09-2.el7_8      updates  </span><br><span class="line">java-1.8.0-openjdk-demo.i686              1:1.8.0.252.b09-2.el7_8      updates  </span><br><span class="line">java-1.8.0-openjdk-demo.x86_64            1:1.8.0.252.b09-2.el7_8      updates  </span><br><span class="line">java-1.8.0-openjdk-devel.i686             1:1.8.0.252.b09-2.el7_8      updates  </span><br><span class="line">java-1.8.0-openjdk-headless.i686          1:1.8.0.252.b09-2.el7_8      updates  </span><br><span class="line">java-1.8.0-openjdk-javadoc.noarch         1:1.8.0.252.b09-2.el7_8      updates  </span><br><span class="line">java-1.8.0-openjdk-javadoc-zip.noarch     1:1.8.0.252.b09-2.el7_8      updates  </span><br><span class="line">java-1.8.0-openjdk-src.i686               1:1.8.0.252.b09-2.el7_8      updates  </span><br><span class="line">java-1.8.0-openjdk-src.x86_64             1:1.8.0.252.b09-2.el7_8      updates</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install java-1.8.0-openjdk.x86_64 java-1.8.0-openjdk-devel.x86_64</span><br></pre></td></tr></table></figure>



<h2 id="安装ZooKeeper"><a href="#安装ZooKeeper" class="headerlink" title="安装ZooKeeper"></a>安装ZooKeeper</h2><h3 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h3><p><a target="_blank" rel="noopener" href="https://zookeeper.apache.org/releases.html">官网下载地址</a></p>
<p>编写下载的shell脚本(复制粘贴, 偷个懒😂)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim download.sh</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p &#x2F;root&#x2F;data&#x2F;zookeeper</span><br><span class="line">cd &#x2F;root&#x2F;data&#x2F;zookeeper</span><br><span class="line">wget https:&#x2F;&#x2F;downloads.apache.org&#x2F;zookeeper&#x2F;zookeeper-3.4.14&#x2F;zookeeper-3.4.14.tar.gz</span><br><span class="line">tar -xvf zookeeper-3.4.14.tar.gz</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>使用source命令可用不需要执行权限</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source download.sh</span><br></pre></td></tr></table></figure>

<p>三个节点都下载好zookeeper</p>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><h4 id="编辑配置文件zoo-conf"><a href="#编辑配置文件zoo-conf" class="headerlink" title="编辑配置文件zoo.conf"></a>编辑配置文件zoo.conf</h4><p>使用模板文件做配置(三个节点的该文件配置都相同)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv zookeeper-3.4.14&#x2F;conf&#x2F;zoo_sample.cfg zookeeper-3.4.14&#x2F;conf&#x2F;zoo.cfg</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@mycat zookeeper-3.4.14]# vim .&#x2F;conf&#x2F;zoo.cfg</span><br><span class="line"></span><br><span class="line">server.2&#x3D;10.10.10.1</span><br><span class="line"># The number of milliseconds of each tick</span><br><span class="line">tickTime&#x3D;2000</span><br><span class="line"># The number of ticks that the initial </span><br><span class="line"># synchronization phase can take</span><br><span class="line">initLimit&#x3D;10</span><br><span class="line"># The number of ticks that can pass between </span><br><span class="line"># sending a request and getting an acknowledgement</span><br><span class="line">syncLimit&#x3D;5</span><br><span class="line"># the directory where the snapshot is stored.</span><br><span class="line"># do not use &#x2F;tmp for storage, &#x2F;tmp here is just </span><br><span class="line"># example sakes.</span><br><span class="line">dataDir&#x3D;&#x2F;tmp&#x2F;zookeeper</span><br><span class="line"># the port at which the clients will connect</span><br><span class="line">clientPort&#x3D;2181</span><br><span class="line"># the maximum number of client connections.</span><br><span class="line"># increase this if you need to handle more clients</span><br><span class="line">#maxClientCnxns&#x3D;60</span><br><span class="line">#</span><br><span class="line"># Be sure to read the maintenance section of the </span><br><span class="line"># administrator guide before turning on autopurge.</span><br><span class="line">#</span><br><span class="line"># http:&#x2F;&#x2F;zookeeper.apache.org&#x2F;doc&#x2F;current&#x2F;zookeeperAdmin.html#sc_maintenance</span><br><span class="line">#</span><br><span class="line"># The number of snapshots to retain in dataDir</span><br><span class="line">#autopurge.snapRetainCount&#x3D;3</span><br><span class="line"># Purge task interval in hours</span><br><span class="line"># Set to &quot;0&quot; to disable auto purge feature</span><br><span class="line">#autopurge.purgeInterval&#x3D;1</span><br><span class="line">server.1&#x3D;10.10.10.11:2888:3888</span><br><span class="line">server.2&#x3D;10.10.10.12:2888:3888</span><br><span class="line">server.3&#x3D;10.10.10.101:2888:3888</span><br></pre></td></tr></table></figure>

<p>说明</p>
<ul>
<li>initLimit：ZooKeeper集群模式下包含多个zk进程，其中一个进程为leader，余下的进程为follower。当follower最初与leader建立连接时，它们之间会传输相当多的数据，尤其是follower的数据落后leader很多。initLimit配置follower与leader之间建立连接后进行同步的最长时间。</li>
<li>syncLimit：配置follower和leader之间发送消息，请求和应答的最大时间长度。</li>
<li>tickTime：tickTime则是上述两个超时配置的基本单位，例如对于initLimit，其配置值为5，说明其超时时间为2000ms*5=10秒。</li>
<li>server.id=host:port1:port2：其中id为一个数字，表示zk进程的id，这个id也是dataDir目录下myid文件的内容。host是该zk进程所在的IP地址，port1表示follower和leader交换消息所使用的端口，port2表示选举leader所使用的端口。</li>
<li>dataDir：其配置的含义跟单机模式下的含义类似，不同的是集群模式下还有一个myid文件。myid文件的内容只有一行，且内容只能为1-255之间的数字，这个数字亦即上面介绍server.id中的id，表示zk进程的id。</li>
<li>clientPort：这个端口就是<strong>客户端连接</strong> Zookeeper 服务器的端口，Zookeeper 会<strong>监听</strong>这个端口，<strong>接受客户端的访问</strong>请求。</li>
</ul>
<h4 id="创建myid文件"><a href="#创建myid文件" class="headerlink" title="创建myid文件"></a>创建myid文件</h4><p>ZooKeeper是根据该文件来决定ZooKeeper集群各个机器的身份分配。</p>
<blockquote>
<p> 主机10.10.10.11</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir &#x2F;tmp&#x2F;zookeeper</span><br><span class="line">vim &#x2F;tmp&#x2F;zookeeper&#x2F;myid</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@mycat zookeeper-3.4.14]# cat &#x2F;tmp&#x2F;zookeeper&#x2F;myid </span><br><span class="line">1</span><br></pre></td></tr></table></figure>

<blockquote>
<p>主机10.10.10.12</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir &#x2F;tmp&#x2F;zookeeper</span><br><span class="line">vim &#x2F;tmp&#x2F;zookeeper&#x2F;myid</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@mycat zookeeper-3.4.14]# cat &#x2F;tmp&#x2F;zookeeper&#x2F;myid </span><br><span class="line">2</span><br></pre></td></tr></table></figure>

<blockquote>
<p>主机10.10.10.101</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir &#x2F;tmp&#x2F;zookeeper</span><br><span class="line">vim &#x2F;tmp&#x2F;zookeeper&#x2F;myid</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@mycat zookeeper-3.4.14]# cat &#x2F;tmp&#x2F;zookeeper&#x2F;myid </span><br><span class="line">3</span><br></pre></td></tr></table></figure>

<h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><p>进入zookeeper-3.4.14/bin目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@mycat bin]# .&#x2F;zkServer.sh start</span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: &#x2F;root&#x2F;data&#x2F;mall&#x2F;zookeeper-3.4.14&#x2F;bin&#x2F;..&#x2F;conf&#x2F;zoo.cfg</span><br><span class="line">Starting zookeeper ... STARTED</span><br></pre></td></tr></table></figure>

<p>*<strong>三个节点到启动成功</strong></p>
<h3 id="查看状态"><a href="#查看状态" class="headerlink" title="查看状态"></a>查看状态</h3><p>三个节点状态</p>
<blockquote>
<p>10.10.10.12节点</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@mycat bin]# .&#x2F;zkServer.sh status</span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: &#x2F;root&#x2F;data&#x2F;mall&#x2F;zookeeper-3.4.14&#x2F;bin&#x2F;..&#x2F;conf&#x2F;zoo.cfg</span><br><span class="line">Mode: leader</span><br></pre></td></tr></table></figure>

<blockquote>
<p>10.10.10.101节点</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@db2 zookeeper-3.4.14]# bin&#x2F;zkServer.sh status</span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: &#x2F;root&#x2F;zookeeper-3.4.14&#x2F;bin&#x2F;..&#x2F;conf&#x2F;zoo.cfg</span><br><span class="line">Mode: follower</span><br></pre></td></tr></table></figure>

<blockquote>
<p>10.10.10.11节点</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@xserver1 zookeeper-3.4.14]# bin&#x2F;zkServer.sh status</span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: &#x2F;root&#x2F;zookeeper-3.4.14&#x2F;bin&#x2F;..&#x2F;conf&#x2F;zoo.cfg</span><br><span class="line">Mode: follwer</span><br></pre></td></tr></table></figure>



<h2 id="结束"><a href="#结束" class="headerlink" title="结束"></a>结束</h2><p>记录其中遇到的一个网络问题:</p>
<p>问题描述: 虚拟机能对域名进行解析, 但不能联网<br>表现状态为使用ping <a target="_blank" rel="noopener" href="http://www.baidu.com/">www.baidu.com</a> 后, 可以解析出IP地址, 但后续动作没有, 一直卡着</p>
<p>解决方法为:  重新添加一次NAT模式的网卡, 重启网络 (还删掉了一张用来做其他实验的仅主机模式的网卡及其网卡配置文件, 不知道是不是它造成的)</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://www.ljh.xyz/2020/08/06/ZooKeeper%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/" data-id="ckkzd08hc00067ou1gq4q6myv" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Centos/" rel="tag">Centos</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux/" rel="tag">Linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%BA%91%E8%AE%A1%E7%AE%97%E4%B8%AD%E7%BA%A7/" rel="tag">云计算中级</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/">下一页 &amp;raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Blog/" rel="tag">Blog</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CTF/" rel="tag">CTF</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Centos/" rel="tag">Centos</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Ceph/" rel="tag">Ceph</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/" rel="tag">Docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker-Compose/" rel="tag">Docker-Compose</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/LNMP/" rel="tag">LNMP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/" rel="tag">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python/" rel="tag">Python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/" rel="tag">docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/openssl/" rel="tag">openssl</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/openstack/" rel="tag">openstack</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/shell/" rel="tag">shell</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/wordpress/" rel="tag">wordpress</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/yum%E6%BA%90/" rel="tag">yum源</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BA%91%E8%AE%A1%E7%AE%97%E4%B8%AD%E7%BA%A7/" rel="tag">云计算中级</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BA%91%E8%AE%A1%E7%AE%97%E5%88%9D%E7%BA%A7/" rel="tag">云计算初级</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8/" rel="tag">分布式存储</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8D%9A%E5%AE%A2/" rel="tag">博客</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%91%BD%E4%BB%A4%E8%A7%A3%E6%9E%90/" rel="tag">命令解析</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92/" rel="tag">容器编排</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AF%86%E9%92%A5/" rel="tag">密钥</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%A7%81%E6%9C%89%E4%BA%91/" rel="tag">私有云</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%A7%86%E9%A2%91/" rel="tag">视频</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/Blog/" style="font-size: 12.5px;">Blog</a> <a href="/tags/CTF/" style="font-size: 10px;">CTF</a> <a href="/tags/Centos/" style="font-size: 20px;">Centos</a> <a href="/tags/Ceph/" style="font-size: 10px;">Ceph</a> <a href="/tags/Docker/" style="font-size: 10px;">Docker</a> <a href="/tags/Docker-Compose/" style="font-size: 10px;">Docker-Compose</a> <a href="/tags/LNMP/" style="font-size: 10px;">LNMP</a> <a href="/tags/Linux/" style="font-size: 17.5px;">Linux</a> <a href="/tags/Python/" style="font-size: 10px;">Python</a> <a href="/tags/docker/" style="font-size: 12.5px;">docker</a> <a href="/tags/openssl/" style="font-size: 10px;">openssl</a> <a href="/tags/openstack/" style="font-size: 12.5px;">openstack</a> <a href="/tags/shell/" style="font-size: 10px;">shell</a> <a href="/tags/wordpress/" style="font-size: 10px;">wordpress</a> <a href="/tags/yum%E6%BA%90/" style="font-size: 10px;">yum源</a> <a href="/tags/%E4%BA%91%E8%AE%A1%E7%AE%97%E4%B8%AD%E7%BA%A7/" style="font-size: 15px;">云计算中级</a> <a href="/tags/%E4%BA%91%E8%AE%A1%E7%AE%97%E5%88%9D%E7%BA%A7/" style="font-size: 10px;">云计算初级</a> <a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8/" style="font-size: 12.5px;">分布式存储</a> <a href="/tags/%E5%8D%9A%E5%AE%A2/" style="font-size: 10px;">博客</a> <a href="/tags/%E5%91%BD%E4%BB%A4%E8%A7%A3%E6%9E%90/" style="font-size: 10px;">命令解析</a> <a href="/tags/%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92/" style="font-size: 10px;">容器编排</a> <a href="/tags/%E5%AF%86%E9%92%A5/" style="font-size: 10px;">密钥</a> <a href="/tags/%E7%A7%81%E6%9C%89%E4%BA%91/" style="font-size: 12.5px;">私有云</a> <a href="/tags/%E8%A7%86%E9%A2%91/" style="font-size: 10px;">视频</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">十一月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">九月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">八月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">七月 2020</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/11/01/%E7%94%A8Python%E5%86%99%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E4%BA%A4%E4%BA%92%E5%BC%8FSSH%E5%AE%A2%E6%88%B7%E7%AB%AF/">用Python写一个简单的交互式SSH客户端</a>
          </li>
        
          <li>
            <a href="/2020/09/21/LNMP%E6%90%AD%E5%BB%BA%E4%B8%8E%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2%E7%9A%84%E9%83%A8%E7%BD%B2/">LNMP搭建与个人博客的部署</a>
          </li>
        
          <li>
            <a href="/2020/08/23/%E8%A7%86%E9%A2%91%E6%B5%8B%E8%AF%95/">视频测试</a>
          </li>
        
          <li>
            <a href="/2020/08/21/Docker%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92%5BDocker%20compose%5D/">Docker容器编排[Docker compose]</a>
          </li>
        
          <li>
            <a href="/2020/08/20/%E9%85%8D%E7%BD%AE%E5%9B%BD%E5%86%85yum%E6%BA%90/">配置国内的yum源</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2021 LJH<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>